name: TypeScript Type Checking

on:
  push:
    branches: [main, dev]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - 'deno.json'
      - 'globals.d.ts'
      - 'lib/types/**'
      - '.github/workflows/type-check.yml'
  pull_request:
    branches: [main, dev]
    paths:
      - '**/*.ts'
      - '**/*.tsx'
      - 'deno.json'
      - 'globals.d.ts'
      - 'lib/types/**'
      - '.github/workflows/type-check.yml'

jobs:
  type-check:
    name: TypeScript Type Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch more history for better diff analysis
          fetch-depth: 0

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.3.3

      - name: Cache Deno dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.deno
            ~/.cache/deno
          key: ${{ runner.os }}-deno-typecheck-${{ hashFiles('**/deno.json') }}
          restore-keys: |
            ${{ runner.os }}-deno-typecheck-
            ${{ runner.os }}-deno-

      - name: Cache dependencies
        run: |
          echo "Caching dependencies for type checking..."
          deno cache --no-check main.ts dev.ts

      - name: Run TypeScript type analysis (non-blocking)
        run: |
          echo "ðŸ” Running comprehensive TypeScript analysis..."
          deno task analyze:types || echo "âš ï¸ Type analysis completed with issues"
          
          # Check main entry points but don't fail the workflow
          echo "ðŸ“‹ Checking main entry points..."
          if deno task check:types; then
            echo "âœ… No type errors in main entry points!"
          else
            echo "âš ï¸ Type errors found in main entry points (expected during gradual improvement)"
            echo "ðŸ“Š This is informational only and doesn't block the workflow"
          fi

      - name: Analyze changed files and check for new errors (PR only)
        if: github.event_name == 'pull_request'
        run: |
          echo "ðŸ” Analyzing TypeScript changes in PR..."
          
          # Get changed TypeScript files
          CHANGED_TS_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E '\.(ts|tsx)$' | grep -v -E '(test|spec)\.(ts|tsx)$' || echo "")
          
          if [ -n "$CHANGED_TS_FILES" ]; then
            echo "ðŸ“ Changed TypeScript files:"
            echo "$CHANGED_TS_FILES"
            echo ""
            
            # Check each changed file and track results
            NEW_ERRORS_FOUND=false
            CHECKED_FILES=0
            FILES_WITH_ERRORS=0
            
            echo "ðŸ” Type checking changed files..."
            for file in $CHANGED_TS_FILES; do
              if [ -f "$file" ]; then
                echo "Checking: $file"
                CHECKED_FILES=$((CHECKED_FILES + 1))
                
                if deno check "$file" 2>&1; then
                  echo "  âœ… No type errors in $file"
                else
                  echo "  âš ï¸ Type errors found in $file"
                  FILES_WITH_ERRORS=$((FILES_WITH_ERRORS + 1))
                  # Note: We're not setting NEW_ERRORS_FOUND=true here because we're in gradual improvement mode
                  # Only fail if there are critical syntax errors or completely broken files
                fi
                echo ""
              fi
            done
            
            echo "ðŸ“Š Summary for changed files:"
            echo "  - Files checked: $CHECKED_FILES"
            echo "  - Files with type errors: $FILES_WITH_ERRORS"
            echo "  - Files without errors: $((CHECKED_FILES - FILES_WITH_ERRORS))"
            
            # Only fail if ALL changed files have errors (likely indicates a systemic issue)
            if [ $CHECKED_FILES -gt 0 ] && [ $FILES_WITH_ERRORS -eq $CHECKED_FILES ] && [ $CHECKED_FILES -gt 2 ]; then
              echo "âŒ All changed files have type errors - this may indicate a systemic issue"
              echo "ðŸ’¡ Consider fixing at least some type errors before merging"
              # Uncomment the next line if you want to fail in this case:
              # exit 1
            else
              echo "âœ… Type checking passed for PR (gradual improvement mode)"
            fi
          else
            echo "ðŸ“ No TypeScript files changed in this PR"
            echo "âœ… No type checking needed for this PR"
          fi

      - name: Generate type check summary
        if: always()
        run: |
          echo "## TypeScript Type Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ¯ **Status**: This workflow is in gradual improvement mode and won't block PRs due to existing type errors." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Read the analysis report if it exists
          if [ -f "reports/type-error-analysis.md" ]; then
            echo "### ðŸ“Š Current Type Error Status" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract key metrics
            TOTAL_ERRORS=$(grep "Total Errors" reports/type-error-analysis.md | head -1 | grep -o '[0-9]*' || echo "Unknown")
            echo "- **Total Errors**: $TOTAL_ERRORS" >> $GITHUB_STEP_SUMMARY
            echo "- **Workflow Status**: Non-blocking (gradual improvement mode)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show top error categories
            echo "### ðŸŽ¯ Top Error Categories" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -A 10 "## Error Categories" reports/type-error-analysis.md | head -15 || echo "Error categories not available" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Show critical files
            echo "### ðŸ”¥ Critical Files (Most Errors)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            grep -A 10 "## Critical Files" reports/type-error-analysis.md | head -15 || echo "Critical files not available" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### ðŸ’¡ Improvement Suggestions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Focus on Easy Wins**: Start with \`MISSING_TYPE\` and \`IMPLICIT_ANY\` errors" >> $GITHUB_STEP_SUMMARY
          echo "2. **File-by-File**: Use \`deno check <file>\` to fix individual files" >> $GITHUB_STEP_SUMMARY
          echo "3. **Track Progress**: Run \`deno task analyze:types\` locally to monitor improvements" >> $GITHUB_STEP_SUMMARY
          echo "4. **Gradual Approach**: The pre-commit hook now warns about type errors in staged files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Goal" >> $GITHUB_STEP_SUMMARY
          echo "Gradually reduce the total error count through incremental improvements. Each fixed error makes the codebase more maintainable!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- This workflow is currently in **gradual improvement mode**" >> $GITHUB_STEP_SUMMARY
          echo "- PRs are not blocked by existing type errors" >> $GITHUB_STEP_SUMMARY
          echo "- Focus on fixing type errors in files you're actively working on" >> $GITHUB_STEP_SUMMARY
          echo "- Once we reach <50 total errors, we can enable strict mode" >> $GITHUB_STEP_SUMMARY

      - name: Upload type analysis report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: type-analysis-report
          path: reports/type-error-analysis.md
          retention-days: 30

      - name: Final status message
        if: always()
        run: |
          echo "ðŸŽ¯ TypeScript Analysis Complete!"
          echo ""
          echo "ðŸ“Š This workflow is in gradual improvement mode:"
          echo "  âœ… Provides comprehensive type error analysis"
          echo "  âœ… Checks changed files in PRs"
          echo "  âœ… Doesn't block PRs due to existing errors"
          echo "  âœ… Encourages incremental improvements"
          echo ""
          echo "ðŸ’¡ To contribute to type safety improvements:"
          echo "  - Fix type errors in files you're actively working on"
          echo "  - Run 'deno check <file>' before committing changes"
          echo "  - Use 'deno task analyze:types' to track overall progress"
          echo ""
          echo "ðŸš€ Once we reduce errors significantly, we'll enable strict blocking mode!" 