name: Lighthouse CI

on:
  push:
    branches: [main, dev]
    paths:
      - 'client/**'
      - 'routes/**'
      - 'islands/**'
      - 'components/**'
      - 'static/**'
      - 'lighthouserc.cjs'
      - '.github/workflows/lighthouse-ci.yml'
  pull_request:
    branches: [main, dev]
    paths:
      - 'client/**'
      - 'routes/**'
      - 'islands/**'
      - 'components/**'
      - 'static/**'
      - 'lighthouserc.cjs'
      - '.github/workflows/lighthouse-ci.yml'
  workflow_dispatch:
    # Allow manual triggering for testing

jobs:
  lighthouse-ci:
    name: Lighthouse CI Performance Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test
          MYSQL_DATABASE: btcstamps_test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      CI: true
      DENO_ENV: development
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: test
      DB_NAME: btcstamps_test
      REDIS_URL: redis://127.0.0.1:6379
      ELASTICACHE_ENDPOINT: 127.0.0.1:6379
      SKIP_REDIS_CONNECTION: false
      QUICKNODE_API_KEY: test-quicknode-key
      ANTHROPIC_API_KEY: test-anthropic-key
      PERPLEXITY_API_KEY: test-perplexity-key
      XCP_API_URL: http://localhost:18443/v2
      MEMPOOL_API_URL: http://localhost:18443/mempool/api
      BLOCKSTREAM_API_URL: http://localhost:18443/blockstream/api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.6.9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install LHCI
        run: npm install -g @lhci/cli@0.14.x

      - name: Cache Deno dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.deno
            ~/.cache/deno
          key: ${{ runner.os }}-deno-lighthouse-${{ hashFiles('**/deno.json') }}
          restore-keys: |
            ${{ runner.os }}-deno-lighthouse-
            ${{ runner.os }}-deno-

      - name: Wait for MySQL
        run: |
          echo "Waiting for MySQL to be ready..."
          timeout 60 bash -c 'until mysqladmin ping -h 127.0.0.1 -P 3306 -u root -ptest --silent; do
            echo "MySQL not ready yet, waiting..."
            sleep 2
          done'
          echo "âœ… MySQL is ready"

      - name: Wait for Redis
        run: |
          echo "Waiting for Redis to be ready..."
          timeout 30 bash -c 'until nc -z 127.0.0.1 6379; do
            echo "Redis not ready yet, waiting..."
            sleep 1
          done'
          echo "âœ… Redis is ready"

      - name: Load test schema and seed data
        run: |
          echo "Loading test schema..."
          mysql -h 127.0.0.1 -P 3306 -u root -ptest btcstamps_test < scripts/test-schema.sql
          echo "âœ… Test schema loaded"
          echo "Loading test seed data..."
          mysql -h 127.0.0.1 -P 3306 -u root -ptest btcstamps_test < scripts/test-seed-data.sql
          echo "âœ… Test seed data loaded"

      - name: Cache Deno dependencies for dev server
        run: |
          echo "Caching Deno dependencies..."
          deno cache --no-check main.ts dev.ts

      - name: Start mock external API server
        run: |
          echo "Starting mock external API server..."
          nohup deno run --allow-net --allow-env scripts/mock-external-apis.ts > mock-api-server.log 2>&1 &
          echo $! > mock-api-server.pid
          echo "Mock server started with PID: $(cat mock-api-server.pid)"

          timeout 15 bash -c 'until curl -f -s http://localhost:18443/health > /dev/null 2>&1; do
            echo "Mock server not ready yet, waiting..."
            sleep 1
          done' || {
            echo "âŒ Mock API server failed to start"
            cat mock-api-server.log || echo "No logs available"
            exit 1
          }
          echo "âœ… Mock external API server is ready"

      - name: Start dev server
        run: |
          echo "Starting Deno dev server in background..."
          nohup deno run -A dev.ts > dev-server.log 2>&1 &
          echo $! > dev-server.pid
          echo "Dev server started with PID: $(cat dev-server.pid)"

          echo "Waiting for dev server to be ready (max 90s)..."
          timeout 90 bash -c 'until curl -f -s http://localhost:8000/api/v2/health > /dev/null 2>&1; do
            echo "Dev server not ready yet, waiting..."
            sleep 3
          done' || {
            echo "âŒ Dev server failed to start within 90 seconds"
            echo "=== Dev Server Logs ==="
            cat dev-server.log || echo "No logs available"
            exit 1
          }

          echo "âœ… Dev server is ready at http://localhost:8000"

      - name: Verify server is responding
        run: |
          echo "Testing server endpoints..."
          curl -f http://localhost:8000/api/v2/health || exit 1
          echo ""
          echo "âœ… Server is responding correctly"

      - name: Run Lighthouse CI - Collect
        continue-on-error: true
        id: lhci-collect
        run: |
          echo "Collecting Lighthouse metrics (desktop preset, 3 runs per URL)..."
          lhci collect --config=lighthouserc.cjs

      - name: Run Lighthouse CI - Assert
        if: steps.lhci-collect.outcome == 'success'
        continue-on-error: true
        run: |
          echo "Asserting performance budgets..."
          lhci assert --config=lighthouserc.cjs

      - name: Run Lighthouse CI - Upload
        if: always()
        run: |
          echo "Uploading Lighthouse reports..."
          lhci upload --config=lighthouserc.cjs || true

      - name: Upload Lighthouse reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-reports
          path: .lighthouseci/
          retention-days: 30

      - name: Display Lighthouse results
        if: always()
        run: |
          echo "## Lighthouse CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Performance Budgets (Desktop)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Budget |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Blocking Time | < 500ms |" >> $GITHUB_STEP_SUMMARY
          echo "| First Contentful Paint | < 2000ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Largest Contentful Paint | < 2500ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Speed Index | < 3500ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Cumulative Layout Shift | < 0.1 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“Š Full reports available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

      - name: Show server logs on failure
        if: failure()
        run: |
          echo "=== Dev Server Logs ==="
          cat dev-server.log || echo "No dev server logs available"

      - name: Cleanup
        if: always()
        run: |
          if [ -f dev-server.pid ]; then
            kill "$(cat dev-server.pid)" 2>/dev/null || true
            echo "âœ… Dev server stopped"
          fi
          if [ -f mock-api-server.pid ]; then
            kill "$(cat mock-api-server.pid)" 2>/dev/null || true
            echo "âœ… Mock API server stopped"
          fi
