name: Fee System Tests

on:
  push:
    branches: [main, dev]
    paths:
      - 'tests/fee-*.test.ts'
      - 'tests/redis-*.test.ts'
      - 'tests/quicknode-*.test.ts'
      - 'tests/btc-price-*.test.ts'
      - 'server/services/fee/**'
      - 'server/services/quicknode/**'
      - 'lib/utils/feeSignal.ts'
      - 'lib/utils/localStorage.ts'
      - 'lib/utils/monitoring.ts'
      - 'lib/utils/balanceUtils.ts'
      - 'routes/api/internal/fees.ts'
      - 'routes/api/internal/btcPrice.ts'
  pull_request:
    branches: [main, dev]
    paths:
      - 'tests/fee-*.test.ts'
      - 'tests/redis-*.test.ts'
      - 'tests/quicknode-*.test.ts'
      - 'tests/btc-price-*.test.ts'
      - 'server/services/fee/**'
      - 'server/services/quicknode/**'
      - 'lib/utils/feeSignal.ts'
      - 'lib/utils/localStorage.ts'
      - 'lib/utils/monitoring.ts'
      - 'lib/utils/balanceUtils.ts'
      - 'routes/api/internal/fees.ts'
      - 'routes/api/internal/btcPrice.ts'

jobs:
  fee-system-tests:
    name: Fee System Tests (with Redis)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      CI: true
      DENO_ENV: test
      SKIP_REDIS_CONNECTION: false
      REDIS_URL: redis://localhost:6379
      # Mock API keys for testing
      QUICKNODE_API_KEY: test-quicknode-key
      ANTHROPIC_API_KEY: test-anthropic-key
      PERPLEXITY_API_KEY: test-perplexity-key

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.3.3

      - name: Wait for Redis
        run: |
          timeout 30 bash -c 'until redis-cli -h localhost -p 6379 ping; do sleep 1; done'

      - name: Run Fee System Tests
        run: |
          echo "Running fee system tests with Redis..."
          deno task test:fees

      - name: Run Redis Fee Tests
        run: |
          echo "Running Redis-specific fee tests..."
          deno task test:redis-fees

      - name: Run Security Tests
        run: |
          echo "Running security validation tests..."
          deno task test:security

      - name: Run Performance Tests
        run: |
          echo "Running performance benchmark tests..."
          deno task test:performance

      - name: Run BTC Price Caching Tests
        run: |
          echo "Running BTC price caching tests..."
          deno task test:btc-price

  fee-system-fallback-tests:
    name: Fee System Fallback Tests (no Redis)
    runs-on: ubuntu-latest
    timeout-minutes: 8

    env:
      CI: true
      DENO_ENV: test
      SKIP_REDIS_CONNECTION: true
      # Mock API keys for testing
      QUICKNODE_API_KEY: test-quicknode-key
      ANTHROPIC_API_KEY: test-anthropic-key
      PERPLEXITY_API_KEY: test-perplexity-key

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.3.3

      - name: Run Fee Fallback Tests
        run: |
          echo "Running fee system tests without Redis (fallback mode)..."
          deno task test:fees

      - name: Run BTC Price Fallback Tests
        run: |
          echo "Running BTC price caching tests in fallback mode..."
          deno task test:btc-price 