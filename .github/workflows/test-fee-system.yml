name: Fee System Tests

on:
  push:
    branches: [main, dev]
    paths:
      - 'tests/unit/services/fee-*.test.ts'
      - 'tests/unit/services/btc-price-*.test.ts'
      - 'server/services/fee/**'
      - 'server/services/price/**'
      - 'server/services/quicknode/**'
      - 'lib/utils/feeSignal.ts'
      - 'lib/utils/localStorage.ts'
      - 'lib/utils/monitoring.ts'
      - 'lib/utils/balanceUtils.ts'
      - 'routes/api/internal/fees.ts'
      - 'routes/api/internal/btcPrice.ts'
  pull_request:
    branches: [main, dev]
    paths:
      - 'tests/unit/services/fee-*.test.ts'
      - 'tests/unit/services/btc-price-*.test.ts'
      - 'server/services/fee/**'
      - 'server/services/price/**'
      - 'server/services/quicknode/**'
      - 'lib/utils/feeSignal.ts'
      - 'lib/utils/localStorage.ts'
      - 'lib/utils/monitoring.ts'
      - 'lib/utils/balanceUtils.ts'
      - 'routes/api/internal/fees.ts'
      - 'routes/api/internal/btcPrice.ts'

jobs:
  fee-system-tests:
    name: Fee System Tests (with Redis)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      DENO_ENV: test
      REDIS_URL: redis://localhost:6379
      SKIP_REDIS_CONNECTION: false
      ELASTICACHE_ENDPOINT: localhost:6379
      MEMPOOL_API_URL: https://mempool.space/api
      QUICKNODE_ENDPOINT: ${{ secrets.QUICKNODE_ENDPOINT }}
      QUICKNODE_API_KEY: ${{ secrets.QUICKNODE_API_KEY }}
      COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY }}
      BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
      KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
      COINBASE_API_KEY: ${{ secrets.COINBASE_API_KEY }}
      BLOCKCHAIN_API_KEY: ${{ secrets.BLOCKCHAIN_API_KEY }}
      BITSTAMP_API_KEY: ${{ secrets.BITSTAMP_API_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: 2.x

      - name: Wait for Redis
        run: |
          echo "Waiting for Redis to be ready..."
          for i in {1..30}; do
            if redis-cli -h localhost ping > /dev/null 2>&1; then
              echo "Redis is ready!"
              break
            fi
            echo "Waiting for Redis... ($i/30)"
            sleep 1
          done
          redis-cli -h localhost ping

      - name: Verify Redis Connection
        run: |
          echo "Testing Redis connection..."
          redis-cli -h localhost set test_key "test_value"
          redis-cli -h localhost get test_key
          redis-cli -h localhost del test_key
          echo "Redis connection verified!"

      - name: Set up test environment
        run: |
          echo "DB_HOST=${{ secrets.DB_HOST || 'localhost' }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER || 'test' }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD || 'test' }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME || 'test_db' }}" >> $GITHUB_ENV

      - name: Run Fee and BTC Price Service Tests
        run: |
          echo "Running fee and BTC price service tests with Redis..."
          cd tests && DENO_ENV=test SKIP_REDIS_CONNECTION=false deno test --allow-all unit/services/fee-*.test.ts unit/services/btc-price-*.test.ts --no-check

  fee-system-fallback-tests:
    name: Fee System Tests (Fallback - No Redis)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    env:
      DENO_ENV: test
      SKIP_REDIS_CONNECTION: true
      MEMPOOL_API_URL: https://mempool.space/api

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: 2.x

      - name: Set up test environment (No Redis)
        run: |
          echo "DB_HOST=${{ secrets.DB_HOST || 'localhost' }}" >> $GITHUB_ENV
          echo "DB_USER=${{ secrets.DB_USER || 'test' }}" >> $GITHUB_ENV
          echo "DB_PASSWORD=${{ secrets.DB_PASSWORD || 'test' }}" >> $GITHUB_ENV
          echo "DB_NAME=${{ secrets.DB_NAME || 'test_db' }}" >> $GITHUB_ENV
          echo "SKIP_REDIS_CONNECTION=true" >> $GITHUB_ENV

      - name: Run Fee System Tests (Fallback Mode)
        run: |
          echo "Running fee system tests without Redis (fallback mode)..."
          cd tests && DENO_ENV=test deno test --allow-all unit/services/fee-*.test.ts --no-check

      - name: Run BTC Price Fallback Tests
        run: |
          echo "Running BTC price caching tests in fallback mode..."
          cd tests && DENO_ENV=test deno test --allow-all unit/services/btc-price-*.test.ts --no-check

  verify-all-tests-pass:
    name: Verify All Tests Pass
    needs: [fee-system-tests, fee-system-fallback-tests]
    runs-on: ubuntu-latest
    steps:
      - name: All tests passed
        run: echo "âœ… All fee system tests passed successfully!"