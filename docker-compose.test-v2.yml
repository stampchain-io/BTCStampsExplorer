services:
  newman:
    image: node:22-alpine
    working_dir: /app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - .:/app
      - ./reports:/app/reports
    environment:
      - NODE_ENV=test
      - DEV_BASE_URL=${DEV_BASE_URL:-http://host.docker.internal:8000}
      - PROD_BASE_URL=${PROD_BASE_URL:-https://stampchain.io}
      - NEWMAN_COLLECTION=${NEWMAN_COLLECTION:-tests/postman/collections/comprehensive.json}
      - NEWMAN_ENVIRONMENT=${NEWMAN_ENVIRONMENT:-tests/postman/environments/comprehensive.json}
      - NEWMAN_REPORTERS=${NEWMAN_REPORTERS:-cli,html,json}
      - NEWMAN_ITERATIONS=${NEWMAN_ITERATIONS:-1}
      - NEWMAN_DELAY_REQUEST=${NEWMAN_DELAY_REQUEST:-0}
      - NEWMAN_TIMEOUT=${NEWMAN_TIMEOUT:-30000}
      - NEWMAN_VERBOSE=${NEWMAN_VERBOSE:-false}
      - NEWMAN_BAIL=${NEWMAN_BAIL:-false}
      - NEWMAN_FOLDER=${NEWMAN_FOLDER:-}
      - REPORT_PREFIX=${REPORT_PREFIX:-newman}
    command: sh scripts/run-newman-enhanced.sh
  
  # Regression testing - v2.3
  newman-regression:
    image: node:22-alpine
    working_dir: /app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - .:/app
      - ./reports:/app/reports
    environment:
      - NODE_ENV=test
      - DEV_BASE_URL=${DEV_BASE_URL:-http://host.docker.internal:8000}
      - PROD_BASE_URL=${PROD_BASE_URL:-https://stampchain.io}
      - NEWMAN_COLLECTION=tests/postman/collections/regression-v23.json
      - NEWMAN_ENVIRONMENT=${NEWMAN_ENVIRONMENT:-tests/postman/environments/comprehensive.json}
      - NEWMAN_REPORTERS=${NEWMAN_REPORTERS:-cli,html,json}
      - NEWMAN_ITERATIONS=${NEWMAN_ITERATIONS:-1}
      - NEWMAN_DELAY_REQUEST=${NEWMAN_DELAY_REQUEST:-0}
      - NEWMAN_TIMEOUT=${NEWMAN_TIMEOUT:-30000}
      - NEWMAN_VERBOSE=${NEWMAN_VERBOSE:-false}
      - NEWMAN_BAIL=${NEWMAN_BAIL:-false}
      - REPORT_PREFIX=newman-regression
    command: sh scripts/run-newman-enhanced.sh

  # Pagination validation testing
  newman-pagination:
    image: node:22-alpine
    working_dir: /app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - .:/app
      - ./reports:/app/reports
    environment:
      - NODE_ENV=test
      - BASE_URL=${BASE_URL:-https://stampchain.io}
      - CURRENT_ENV=${CURRENT_ENV:-prod}
      - NEWMAN_COLLECTION=tests/postman/collections/pagination-validation.json
      - NEWMAN_ENVIRONMENT=${NEWMAN_ENVIRONMENT:-tests/postman/environments/comprehensive.json}
      - NEWMAN_REPORTERS=${NEWMAN_REPORTERS:-cli,html,json}
      - NEWMAN_ITERATIONS=${NEWMAN_ITERATIONS:-1}
      - NEWMAN_DELAY_REQUEST=${NEWMAN_DELAY_REQUEST:-0}
      - NEWMAN_TIMEOUT=${NEWMAN_TIMEOUT:-30000}
      - NEWMAN_VERBOSE=${NEWMAN_VERBOSE:-false}
      - NEWMAN_BAIL=${NEWMAN_BAIL:-false}
      - REPORT_PREFIX=newman-pagination
    command: sh scripts/run-newman-pagination-validation-simple.sh

  # Smoke testing - quick health check
  newman-smoke:
    image: node:22-alpine
    working_dir: /app
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - .:/app
      - ./reports:/app/reports
    environment:
      - NODE_ENV=test
      - BASE_URL=${BASE_URL:-http://host.docker.internal:8000}
      - NEWMAN_COLLECTION=tests/postman/collections/smoke.json
      - NEWMAN_ENVIRONMENT=${NEWMAN_ENVIRONMENT:-tests/postman/environments/default.json}
      - NEWMAN_REPORTERS=${NEWMAN_REPORTERS:-cli,html,json}
      - NEWMAN_BAIL=${NEWMAN_BAIL:-true}
      - NEWMAN_TIMEOUT=${NEWMAN_TIMEOUT:-5000}
      - REPORT_PREFIX=newman-smoke
    command: sh scripts/run-newman-enhanced.sh