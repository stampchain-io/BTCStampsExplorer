echo "üîç Running security checks..."

# Check for potential secrets and sensitive information
check_secrets() {
    local files="$1"
    local found_issues=false
    
    echo "Checking for potential secrets..."
    
    # API keys and tokens - use simpler patterns
    secret_matches=$(echo "$files" | grep -E "api.*key|secret|token|password|auth" | head -20)
    if [ -n "$secret_matches" ]; then
        echo "‚ö†Ô∏è  Potential secret patterns found:"
        echo "$secret_matches" | sed 's/^/   /'
        found_issues=true
    fi
    
    # Common secret patterns - use simpler patterns
    api_key_matches=$(echo "$files" | grep -E "sk_|pk_|ghp_|gho_|ghu_|ghs_|ghr_|github_pat_" | head -20)
    if [ -n "$api_key_matches" ]; then
        echo "‚ö†Ô∏è  Potential API key patterns found:"
        echo "$api_key_matches" | sed 's/^/   /'
        found_issues=true
    fi
    
    # Personal directory paths - use simpler patterns
    path_matches=$(echo "$files" | grep -E "/Users/|/home/|C:\\\\Users" | head -20)
    if [ -n "$path_matches" ]; then
        echo "‚ö†Ô∏è  Personal directory paths detected:"
        echo "$path_matches" | sed 's/^/   /'
        found_issues=true
    fi
    
    # Local config files - use simpler patterns
    config_matches=$(echo "$files" | grep -E "\.env|config\.local|\.local" | head -20)
    if [ -n "$config_matches" ]; then
        echo "‚ö†Ô∏è  Potential local config file references:"
        echo "$config_matches" | sed 's/^/   /'
        found_issues=true
    fi
    
    if [ "$found_issues" = true ]; then
        echo ""
        echo "‚ùå Security check failed! Please review the flagged content above."
        echo "   If these are false positives (error messages, legitimate code, etc.),"
        echo "   you can commit with: git commit --no-verify"
        echo ""
        return 1
    fi
    
    echo "‚úÖ No security issues detected"
    return 0
}

# Get staged files
staged_files=$(git diff --cached --name-only)

if [ -z "$staged_files" ]; then
    echo "No staged files to check"
    exit 0
fi

# Get file contents for security check
file_contents=$(git diff --cached)

# Run security checks
if ! check_secrets "$file_contents"; then
    exit 1
fi

echo "‚úÖ All security checks passed!"

    # Format and lint checks
    deno task check:fmt
    if [ $? -ne 0 ]; then
      echo "Formatting failed. Please run 'deno fmt .' to fix."
      exit 1
    fi

    deno task check:lint
    if [ $? -ne 0 ]; then
      echo "Linting failed. Please fix lint errors."
      exit 1
    fi

    # Additional linting for staged server files (gradual approach)
    echo "üîç Checking lint for staged server files..."
    STAGED_SERVER_FILES=$(git diff --cached --name-only | grep -E '^server/.*\.(ts|tsx)$' | tr '\n' ' ')

    if [ -n "$STAGED_SERVER_FILES" ]; then
        echo "üìù Staged server files: $STAGED_SERVER_FILES"
        
        # Run lint on each server file with relaxed rules
        LINT_FAILED=0
        for file in $STAGED_SERVER_FILES; do
            if [ -f "$file" ]; then
                LINT_OUTPUT=$(deno lint --quiet --rules-tags=recommended --rules-exclude=no-explicit-any,ban-untagged-todo "$file" 2>&1)
                if [ $? -ne 0 ]; then
                    echo "‚ö†Ô∏è  Lint errors in $file:"
                    echo "$LINT_OUTPUT" | head -10
                    LINT_FAILED=1
                fi
            fi
        done
        
        if [ $LINT_FAILED -eq 1 ]; then
            echo ""
            echo "‚ùå Server file linting failed. Please fix critical lint errors."
            echo "üí° Tip: Common issues to fix:"
            echo "   - Unused variables (prefix with _ if intentional)"
            echo "   - Missing error handling"
            echo "   - Use const instead of let where possible"
            exit 1
        else
            echo "‚úÖ Server files lint check passed"
        fi
    fi

    # TypeScript type checking for staged files
    echo "üîç Checking TypeScript types for staged files..."
    deno task check:types:staged

    # All good!
    echo "üéâ Pre-commit checks completed successfully"
    exit 0
fi
