# Security check: Detect exposed secrets and local paths
echo "üîí Checking for secrets and local paths..."

# Flag to track if we found any issues
FOUND_ISSUES=0

# Check staged files for potential secrets and local paths
for file in $(git diff --cached --name-only); do
    if [ -f "$file" ]; then
        # Check for common secret patterns
        if git diff --cached "$file" | grep -E "(API_KEY|SECRET|PASSWORD|TOKEN|PRIVATE)" | grep -v "^[[:space:]]*#" | grep -q "="; then
            echo "‚ùå Potential secret found in $file"
            echo "   Please review and ensure no actual secrets are committed"
            FOUND_ISSUES=1
        fi
        
        # Check for absolute local paths outside repository
        if git diff --cached "$file" | grep -E "^[+].*(/Users/|/home/|C:\\\\|/tmp/|/var/)" | grep -v "BTCStampsExplorer" | grep -q .; then
            echo "‚ùå Local file path detected in $file"
            echo "   Please remove absolute paths outside the repository"
            FOUND_ISSUES=1
        fi
        
        # Check for common sensitive file patterns
        if git diff --cached "$file" | grep -E "(\.env\.local|\.log|settings\.local|config\.local)" | grep -q .; then
            echo "‚ö†Ô∏è  Potential local config file reference in $file"
            echo "   Please verify this should be committed"
        fi
    fi
done

if [ $FOUND_ISSUES -eq 1 ]; then
    echo "‚ùå Security check failed - commit aborted"
    exit 1
fi

echo "‚úÖ Security checks passed"

# Format and lint checks
deno task check:fmt
if [ $? -ne 0 ]; then
  echo "Formatting failed. Please run 'deno fmt .' to fix."
  exit 1
fi

deno task check:lint
if [ $? -ne 0 ]; then
  echo "Linting failed. Please fix lint errors."
  exit 1
fi

# Additional linting for staged server files (gradual approach)
echo "üîç Checking lint for staged server files..."
STAGED_SERVER_FILES=$(git diff --cached --name-only | grep -E '^server/.*\.(ts|tsx)$' | tr '\n' ' ')

if [ -n "$STAGED_SERVER_FILES" ]; then
    echo "üìù Staged server files: $STAGED_SERVER_FILES"
    
    # Run lint on each server file with relaxed rules
    LINT_FAILED=0
    for file in $STAGED_SERVER_FILES; do
        if [ -f "$file" ]; then
            LINT_OUTPUT=$(deno lint --quiet --rules-tags=recommended --rules-exclude=no-explicit-any,ban-untagged-todo "$file" 2>&1)
            if [ $? -ne 0 ]; then
                echo "‚ö†Ô∏è  Lint errors in $file:"
                echo "$LINT_OUTPUT" | head -10
                LINT_FAILED=1
            fi
        fi
    done
    
    if [ $LINT_FAILED -eq 1 ]; then
        echo ""
        echo "‚ùå Server file linting failed. Please fix critical lint errors."
        echo "üí° Tip: Common issues to fix:"
        echo "   - Unused variables (prefix with _ if intentional)"
        echo "   - Missing error handling"
        echo "   - Use const instead of let where possible"
        exit 1
    else
        echo "‚úÖ Server files lint check passed"
    fi
fi

# TypeScript type checking for staged files only
echo "üîç Checking TypeScript types for staged files..."

# Get staged TypeScript files
STAGED_TS_FILES=$(git diff --cached --name-only | grep -E '\.(ts|tsx)$' | grep -v -E '(test|spec)\.(ts|tsx)$' | tr '\n' ' ')

if [ -n "$STAGED_TS_FILES" ]; then
    echo "üìù Staged TypeScript files: $STAGED_TS_FILES"
    
    # Check types for staged files only (allow some errors for gradual improvement)
    echo "   Running incremental type check..."
    
    # Create a temporary file to capture type errors
    TYPE_ERRORS=$(deno check $STAGED_TS_FILES 2>&1 || true)
    
    if echo "$TYPE_ERRORS" | grep -q "error:"; then
        ERROR_COUNT=$(echo "$TYPE_ERRORS" | grep -c "error:" || echo "0")
        echo "‚ö†Ô∏è  Found $ERROR_COUNT TypeScript errors in staged files:"
        echo "$TYPE_ERRORS" | head -20  # Show first 20 errors
        
        # Allow commit but warn about errors (gradual improvement approach)
        echo ""
        echo "üìã Type errors found but commit allowed (gradual improvement mode)"
        echo "üí° Consider fixing these errors when convenient:"
        echo "   - Run 'deno task analyze:types' to see all project errors"
        echo "   - Focus on MISSING_TYPE and IMPLICIT_ANY errors first"
        echo "   - Use 'deno check <file>' to check individual files"
        echo ""
        
        # Optionally fail on critical errors (uncomment to be stricter)
        # if [ $ERROR_COUNT -gt 10 ]; then
        #     echo "‚ùå Too many type errors ($ERROR_COUNT) - commit blocked"
        #     echo "   Please fix critical errors before committing"
        #     exit 1
        # fi
    else
        echo "‚úÖ No TypeScript errors in staged files"
    fi
else
    echo "üìù No TypeScript files staged for commit"
fi

# All good!
echo "üéâ Pre-commit checks completed successfully"
exit 0
