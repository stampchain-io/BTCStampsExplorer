{
  "info": {
    "name": "BTC Stamps Explorer API - v2.3 Regression Testing",
    "description": "Focused regression test to detect v2.3 differences between dev and production",
    "version": "1.0.0",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "comparison_results",
      "value": "[]",
      "type": "any"
    },
    {
      "key": "test_session_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "test_stamp_id",
      "value": "1135630",
      "type": "string"
    },
    {
      "key": "test_address",
      "value": "bc1qzxszplp8v7w0jc89dlrqyct9staqlhwxzy7lkq",
      "type": "string"
    },
    {
      "key": "test_block",
      "value": "903108",
      "type": "string"
    },
    {
      "key": "test_src20_tick",
      "value": "STAMP",
      "type": "string"
    },
    {
      "key": "test_src20_tick_invalid",
      "value": "TOOLONG",
      "type": "string"
    },
    {
      "key": "dev_recent_sales_basic_time",
      "value": "",
      "type": "string"
    },
    {
      "key": "prod_recent_sales_basic_time",
      "value": "",
      "type": "string"
    },
    {
      "key": "dev_recent_sales_enhanced_time",
      "value": "",
      "type": "string"
    },
    {
      "key": "prod_recent_sales_enhanced_time",
      "value": "",
      "type": "string"
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Initialize test session",
          "if (!pm.collectionVariables.get('test_session_id')) {",
          "    const sessionId = 'test_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);",
          "    pm.collectionVariables.set('test_session_id', sessionId);",
          "    console.log('ðŸš€ Starting v2.3 regression test session:', sessionId);",
          "}",
          "",
          "// Log each request",
          "const requestUrl = pm.request.url.toString();",
          "console.log(`ðŸ“¤ Request: ${pm.request.method} ${requestUrl}`);"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Common test validations",
          "pm.test('Response status is valid', () => {",
          "    pm.expect(pm.response.code).to.be.oneOf([200, 201, 400, 404, 500]);",
          "});",
          "",
          "pm.test('Response time is acceptable', () => {",
          "    pm.expect(pm.response.responseTime).to.be.below(10000);",
          "});",
          "",
          "pm.test('Response has valid JSON', () => {",
          "    pm.response.to.have.jsonBody();",
          "});",
          "",
          "// Store response for comparison",
          "const endpoint = pm.request.url.getPath();",
          "const isDev = pm.request.url.toString().includes('localhost') || pm.request.url.toString().includes('host.docker.internal');",
          "const testEnvironment = isDev ? 'development' : 'production';",
          "",
          "// Parse response body (check if already declared)",
          "if (typeof responseBody === 'undefined') {",
          "    var responseBody;",
          "}",
          "try {",
          "    responseBody = pm.response.json();",
          "} catch (e) {",
          "    responseBody = { error: 'Failed to parse JSON', text: pm.response.text() };",
          "}",
          "",
          "const responseData = {",
          "    endpoint: endpoint,",
          "    environment: testEnvironment,",
          "    status: pm.response.code,",
          "    responseTime: pm.response.responseTime,",
          "    size: pm.response.responseSize,",
          "    body: responseBody",
          "};",
          "",
          "// Add to comparison results",
          "let results = JSON.parse(pm.collectionVariables.get('comparison_results') || '[]');",
          "results.push(responseData);",
          "pm.collectionVariables.set('comparison_results', JSON.stringify(results));"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "Key v2.3 Endpoints",
      "item": [
        {
          "name": "List Stamps - Dev",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{dev_base_url}}/api/v2/stamps?limit=2&page=1",
              "host": [
                "{{dev_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "2"
                },
                {
                  "key": "page",
                  "value": "1"
                }
              ]
            }
          }
        },
        {
          "name": "List Stamps - Prod",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{prod_base_url}}/api/v2/stamps?limit=2&page=1",
              "host": [
                "{{prod_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "2"
                },
                {
                  "key": "page",
                  "value": "1"
                }
              ]
            }
          }
        },
        {
          "name": "Get Stamp by ID - Dev",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{dev_base_url}}/api/v2/stamps/{{test_stamp_id}}",
              "host": [
                "{{dev_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps",
                "{{test_stamp_id}}"
              ]
            }
          }
        },
        {
          "name": "Get Stamp by ID - Prod",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{prod_base_url}}/api/v2/stamps/{{test_stamp_id}}",
              "host": [
                "{{prod_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps",
                "{{test_stamp_id}}"
              ]
            }
          }
        },
        {
          "name": "Stamps Pagination Test - Dev",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{dev_base_url}}/api/v2/stamps?limit=10&page=2",
              "host": [
                "{{dev_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "10"
                },
                {
                  "key": "page",
                  "value": "2"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Pagination metadata structure', () => {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('page');",
                  "    pm.expect(body).to.have.property('limit');", 
                  "    pm.expect(body).to.have.property('total');",
                  "    pm.expect(body).to.have.property('totalPages');",
                  "    pm.expect(typeof body.page).to.equal('number');",
                  "    pm.expect(typeof body.limit).to.equal('number');",
                  "    pm.expect(typeof body.total).to.equal('number');",
                  "    pm.expect(typeof body.totalPages).to.equal('number');",
                  "});",
                  "",
                  "pm.test('Data array structure validation', () => {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('data');",
                  "    pm.expect(Array.isArray(body.data)).to.be.true;",
                  "    if (body.data.length > 0) {",
                  "        const stamp = body.data[0];",
                  "        pm.expect(stamp).to.have.property('stamp');",
                  "        pm.expect(typeof stamp.stamp).to.equal('number');",
                  "        pm.expect(stamp).to.have.property('ident');",
                  "        pm.expect(typeof stamp.ident).to.equal('string');",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Stamps Pagination Test - Prod",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{prod_base_url}}/api/v2/stamps?limit=10&page=2",
              "host": [
                "{{prod_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "10"
                },
                {
                  "key": "page",
                  "value": "2"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Pagination metadata structure', () => {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('page');",
                  "    pm.expect(body).to.have.property('limit');", 
                  "    pm.expect(body).to.have.property('total');",
                  "    pm.expect(body).to.have.property('totalPages');",
                  "    pm.expect(typeof body.page).to.equal('number');",
                  "    pm.expect(typeof body.limit).to.equal('number');",
                  "    pm.expect(typeof body.total).to.equal('number');",
                  "    pm.expect(typeof body.totalPages).to.equal('number');",
                  "});",
                  "",
                  "pm.test('Data array structure validation', () => {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('data');",
                  "    pm.expect(Array.isArray(body.data)).to.be.true;",
                  "    if (body.data.length > 0) {",
                  "        const stamp = body.data[0];",
                  "        pm.expect(stamp).to.have.property('stamp');",
                  "        pm.expect(typeof stamp.stamp).to.equal('number');",
                  "        pm.expect(stamp).to.have.property('ident');",
                  "        pm.expect(typeof stamp.ident).to.equal('string');",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Get Collections - Dev",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{dev_base_url}}/api/v2/collections?limit=2",
              "host": [
                "{{dev_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "collections"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "2"
                }
              ]
            }
          }
        },
        {
          "name": "Get Collections - Prod",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{prod_base_url}}/api/v2/collections?limit=2",
              "host": [
                "{{prod_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "collections"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "2"
                }
              ]
            }
          }
        },
        {
          "name": "Invalid SRC20 Tick - Dev",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{dev_base_url}}/api/v2/src20/tick/{{test_src20_tick_invalid}}",
              "host": [
                "{{dev_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "src20",
                "tick",
                "{{test_src20_tick_invalid}}"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Returns 400 for invalid tick length', () => {",
                  "    pm.expect(pm.response.code).to.equal(400);",
                  "});",
                  "",
                  "pm.test('Error message mentions tick length', () => {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body.error || body.message || '').to.match(/tick|length|5/i);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Invalid SRC20 Tick - Prod",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{prod_base_url}}/api/v2/src20/tick/{{test_src20_tick_invalid}}",
              "host": [
                "{{prod_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "src20",
                "tick",
                "{{test_src20_tick_invalid}}"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// Production currently returns 200, but should return 400",
                  "pm.test('Check tick validation behavior', () => {",
                  "    // Note: Production needs to be fixed to return 400",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 400]);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Recent Sales Basic - Dev",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{dev_base_url}}/api/v2/stamps/recentSales?limit=5&page=1",
              "host": [
                "{{dev_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps",
                "recentSales"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "5"
                },
                {
                  "key": "page",
                  "value": "1"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Recent Sales - Basic structure validation', () => {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('data');",
                  "    pm.expect(Array.isArray(body.data)).to.be.true;",
                  "    pm.expect(body).to.have.property('total');",
                  "    pm.expect(typeof body.total).to.equal('number');",
                  "});",
                  "",
                  "pm.test('Recent Sales - Performance benchmark', () => {",
                  "    // Store response time for performance comparison",
                  "    pm.collectionVariables.set('dev_recent_sales_basic_time', pm.response.responseTime);",
                  "    pm.expect(pm.response.responseTime).to.be.below(3000);",
                  "});",
                  "",
                  "pm.test('Recent Sales - Enhanced v2.3 fields present', () => {",
                  "    const body = pm.response.json();",
                  "    if (body.data && body.data.length > 0) {",
                  "        const sale = body.data[0];",
                  "        // Check for v2.3 enhanced sale data structure",
                  "        if (sale.sale_data || sale.marketData) {",
                  "            pm.expect(sale).to.satisfy((item) => {",
                  "                return item.sale_data || item.marketData;",
                  "            });",
                  "        }",
                  "        // Verify stamp properties are present",
                  "        pm.expect(sale).to.have.property('stamp');",
                  "        pm.expect(typeof sale.stamp).to.equal('number');",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Recent Sales Basic - Prod",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{prod_base_url}}/api/v2/stamps/recentSales?limit=5&page=1",
              "host": [
                "{{prod_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps",
                "recentSales"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "5"
                },
                {
                  "key": "page",
                  "value": "1"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Recent Sales - Basic structure validation', () => {",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('data');",
                  "    pm.expect(Array.isArray(body.data)).to.be.true;",
                  "    pm.expect(body).to.have.property('total');",
                  "    pm.expect(typeof body.total).to.equal('number');",
                  "});",
                  "",
                  "pm.test('Recent Sales - Performance benchmark', () => {",
                  "    // Store response time for performance comparison",
                  "    pm.collectionVariables.set('prod_recent_sales_basic_time', pm.response.responseTime);",
                  "    pm.expect(pm.response.responseTime).to.be.below(3000);",
                  "});",
                  "",
                  "pm.test('Recent Sales - Core v2.2 fields maintained', () => {",
                  "    const body = pm.response.json();",
                  "    if (body.data && body.data.length > 0) {",
                  "        const sale = body.data[0];",
                  "        // Verify backward compatibility - core stamp fields should exist",
                  "        pm.expect(sale).to.have.property('stamp');",
                  "        pm.expect(typeof sale.stamp).to.equal('number');",
                  "        pm.expect(sale).to.have.property('cpid');",
                  "        pm.expect(typeof sale.cpid).to.equal('string');",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Recent Sales Enhanced Parameters - Dev",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{dev_base_url}}/api/v2/stamps/recentSales?limit=3&page=1&dayRange=7&fullDetails=true",
              "host": [
                "{{dev_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps",
                "recentSales"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "3"
                },
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "dayRange",
                  "value": "7"
                },
                {
                  "key": "fullDetails",
                  "value": "true"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Recent Sales Enhanced - v2.3 parameter support', () => {",
                  "    // dayRange and fullDetails are v2.3 enhancements",
                  "    pm.expect(pm.response.code).to.equal(200);",
                  "    const body = pm.response.json();",
                  "    pm.expect(body).to.have.property('data');",
                  "});",
                  "",
                  "pm.test('Recent Sales Enhanced - Full details structure', () => {",
                  "    const body = pm.response.json();",
                  "    if (body.data && body.data.length > 0) {",
                  "        const sale = body.data[0];",
                  "        // With fullDetails=true, expect enhanced structure",
                  "        pm.expect(sale).to.have.property('stamp');",
                  "        pm.expect(sale).to.have.property('cpid');",
                  "        ",
                  "        // Check for enhanced sale data fields (v2.3)",
                  "        if (sale.sale_data) {",
                  "            pm.expect(sale.sale_data).to.be.an('object');",
                  "            pm.expect(sale.sale_data).to.have.property('btc_amount');",
                  "            pm.expect(typeof sale.sale_data.btc_amount).to.equal('number');",
                  "        }",
                  "        ",
                  "        // Check for market data fields (v2.3)",
                  "        if (sale.marketData) {",
                  "            pm.expect(sale.marketData).to.be.an('object');",
                  "            pm.expect(sale.marketData).to.have.property('cpid');",
                  "        }",
                  "    }",
                  "});",
                  "",
                  "pm.test('Recent Sales Enhanced - Performance with full details', () => {",
                  "    // Enhanced queries should still be performant",
                  "    pm.collectionVariables.set('dev_recent_sales_enhanced_time', pm.response.responseTime);",
                  "    pm.expect(pm.response.responseTime).to.be.below(5000);",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Recent Sales Enhanced Parameters - Prod", 
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{prod_base_url}}/api/v2/stamps/recentSales?limit=3&page=1&dayRange=7&fullDetails=true",
              "host": [
                "{{prod_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps",
                "recentSales"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "3"
                },
                {
                  "key": "page",
                  "value": "1"
                },
                {
                  "key": "dayRange",
                  "value": "7"
                },
                {
                  "key": "fullDetails",
                  "value": "true"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Recent Sales Enhanced Params - v2.2 behavior', () => {",
                  "    // In v2.2, enhanced parameters may be ignored but shouldn't break",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 400]);",
                  "    if (pm.response.code === 200) {",
                  "        const body = pm.response.json();",
                  "        pm.expect(body).to.have.property('data');",
                  "        pm.expect(Array.isArray(body.data)).to.be.true;",
                  "    }",
                  "});",
                  "",
                  "pm.test('Recent Sales Enhanced Params - Performance baseline', () => {",
                  "    pm.collectionVariables.set('prod_recent_sales_enhanced_time', pm.response.responseTime);",
                  "    if (pm.response.code === 200) {",
                  "        pm.expect(pm.response.responseTime).to.be.below(5000);",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Recent Sales Error Handling - Dev",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{dev_base_url}}/api/v2/stamps/recentSales?limit=9999&page=1",
              "host": [
                "{{dev_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps",
                "recentSales"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "9999"
                },
                {
                  "key": "page", 
                  "value": "1"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Recent Sales Error - Limit validation (v2.3)', () => {",
                  "    // v2.3 should have enhanced validation",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 400]);",
                  "    if (pm.response.code === 400) {",
                  "        const body = pm.response.json();",
                  "        pm.expect(body).to.have.property('error');",
                  "        pm.expect(body.error.toLowerCase()).to.satisfy((msg) => {",
                  "            return msg.includes('limit') || msg.includes('maximum');",
                  "        });",
                  "    }",
                  "});"
                ]
              }
            }
          ]
        },
        {
          "name": "Recent Sales Error Handling - Prod",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              }
            ],
            "url": {
              "raw": "{{prod_base_url}}/api/v2/stamps/recentSales?limit=9999&page=1",
              "host": [
                "{{prod_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "stamps",
                "recentSales"
              ],
              "query": [
                {
                  "key": "limit",
                  "value": "9999"
                },
                {
                  "key": "page",
                  "value": "1"
                }
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('Recent Sales Error - v2.2 behavior', () => {",
                  "    // v2.2 may handle large limits differently",
                  "    pm.expect(pm.response.code).to.be.oneOf([200, 400, 500]);",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    },
    {
      "name": "Generate Final Comparison Report",
      "item": [
        {
          "name": "Final Report",
          "request": {
            "method": "GET",
            "header": [],
            "url": {
              "raw": "{{dev_base_url}}/api/v2/health",
              "host": [
                "{{dev_base_url}}"
              ],
              "path": [
                "api",
                "v2",
                "health"
              ]
            }
          },
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// Enhanced comparison report with deep field comparison",
                  "const results = JSON.parse(pm.collectionVariables.get('comparison_results') || '[]');",
                  "",
                  "// Helper function to validate JSON structure and types",
                  "function validateStructure(obj, environment, endpoint) {",
                  "    const issues = [];",
                  "    ",
                  "    // Common API response structure validation",
                  "    if (endpoint.includes('/stamps') && !endpoint.includes('/balance')) {",
                  "        // Validate pagination structure for list endpoints",
                  "        if ((endpoint === '/api/v2/stamps' || endpoint.includes('/recentSales')) && !obj.stamp_id) {", 
                  "            if (typeof obj.page !== 'number') issues.push(`${environment}: 'page' should be number, got ${typeof obj.page}`);",
                  "            if (typeof obj.limit !== 'number') issues.push(`${environment}: 'limit' should be number, got ${typeof obj.limit}`);",
                  "            if (typeof obj.total !== 'number') issues.push(`${environment}: 'total' should be number, got ${typeof obj.total}`);",
                  "            if (typeof obj.totalPages !== 'number') issues.push(`${environment}: 'totalPages' should be number, got ${typeof obj.totalPages}`);",
                  "            if (!Array.isArray(obj.data)) issues.push(`${environment}: 'data' should be array, got ${typeof obj.data}`);",
                  "        }",
                  "        ",
                  "        // Validate stamp object structure",
                  "        const stamps = Array.isArray(obj.data) ? obj.data : (obj.data && obj.data.stamp ? [obj.data.stamp] : []);",
                  "        stamps.forEach((stamp, index) => {",
                  "            if (stamp && typeof stamp === 'object') {",
                  "                if (typeof stamp.stamp !== 'number') issues.push(`${environment}: stamps[${index}].stamp should be number`);",
                  "                if (typeof stamp.ident !== 'string') issues.push(`${environment}: stamps[${index}].ident should be string`);",
                  "                // Validate v2.3 fields if present",
                  "                if (stamp.marketData && typeof stamp.marketData !== 'object') {",
                  "                    issues.push(`${environment}: stamps[${index}].marketData should be object`);",
                  "                }",
                  "                if (stamp.cacheStatus && typeof stamp.cacheStatus !== 'string') {",
                  "                    issues.push(`${environment}: stamps[${index}].cacheStatus should be string`);",
                  "                }",
                  "                // Validate recent sales specific fields (v2.3 enhancements)",
                  "                if (endpoint.includes('/recentSales') && stamp.sale_data) {",
                  "                    if (typeof stamp.sale_data !== 'object') {",
                  "                        issues.push(`${environment}: stamps[${index}].sale_data should be object`);",
                  "                    } else {",
                  "                        if (stamp.sale_data.btc_amount !== undefined && typeof stamp.sale_data.btc_amount !== 'number') {",
                  "                            issues.push(`${environment}: stamps[${index}].sale_data.btc_amount should be number`);",
                  "                        }",
                  "                        if (stamp.sale_data.block_index !== undefined && typeof stamp.sale_data.block_index !== 'number') {",
                  "                            issues.push(`${environment}: stamps[${index}].sale_data.block_index should be number`);",
                  "                        }",
                  "                        if (stamp.sale_data.tx_hash !== undefined && typeof stamp.sale_data.tx_hash !== 'string') {",
                  "                            issues.push(`${environment}: stamps[${index}].sale_data.tx_hash should be string`);",
                  "                        }",
                  "                    }",
                  "                }",
                  "            }",
                  "        });",
                  "    }",
                  "    ",
                  "    // Validate collections structure",
                  "    if (endpoint.includes('/collections')) {",
                  "        if (Array.isArray(obj.data)) {",
                  "            obj.data.forEach((collection, index) => {",
                  "                if (collection && typeof collection === 'object') {",
                  "                    if (typeof collection.collection_id !== 'string') issues.push(`${environment}: collections[${index}].collection_id should be string`);",
                  "                    if (typeof collection.collection_name !== 'string') issues.push(`${environment}: collections[${index}].collection_name should be string`);",
                  "                }",
                  "            });",
                  "        }",
                  "    }",
                  "    ",
                  "    return issues;",
                  "}",
                  "",
                  "// Helper function to deep compare objects",
                  "function deepCompare(obj1, obj2, path = '') {",
                  "    const differences = [];",
                  "    ",
                  "    // Get all keys from both objects",
                  "    const allKeys = new Set([...Object.keys(obj1 || {}), ...Object.keys(obj2 || {})]);",
                  "    ",
                  "    for (const key of allKeys) {",
                  "        const newPath = path ? `${path}.${key}` : key;",
                  "        ",
                  "        // Key only in obj1 (added in dev)",
                  "        if (key in obj1 && !(key in obj2)) {",
                  "            differences.push({",
                  "                type: 'added',",
                  "                path: newPath,",
                  "                devValue: obj1[key],",
                  "                prodValue: undefined",
                  "            });",
                  "        }",
                  "        // Key only in obj2 (removed in dev)",
                  "        else if (!(key in obj1) && key in obj2) {",
                  "            differences.push({",
                  "                type: 'removed',",
                  "                path: newPath,",
                  "                devValue: undefined,",
                  "                prodValue: obj2[key]",
                  "            });",
                  "        }",
                  "        // Key in both, check if values differ",
                  "        else if (key in obj1 && key in obj2) {",
                  "            const val1 = obj1[key];",
                  "            const val2 = obj2[key];",
                  "            ",
                  "            if (typeof val1 === 'object' && val1 !== null && ",
                  "                typeof val2 === 'object' && val2 !== null &&",
                  "                !Array.isArray(val1) && !Array.isArray(val2)) {",
                  "                // Recursively compare objects",
                  "                differences.push(...deepCompare(val1, val2, newPath));",
                  "            } else if (Array.isArray(val1) && Array.isArray(val2)) {",
                  "                // Compare array structure, not content (to avoid false positives from data changes)",
                  "                if (val1.length > 0 && val2.length > 0 && typeof val1[0] === 'object' && typeof val2[0] === 'object') {",
                  "                    // Compare structure of first array element",
                  "                    differences.push(...deepCompare(val1[0], val2[0], `${newPath}[0]`));",
                  "                }",
                  "            } else if (JSON.stringify(val1) !== JSON.stringify(val2)) {",
                  "                // Skip certain dynamic fields that always differ",
                  "                const skipFields = ['last_block', 'block_time', 'timestamp', 'responseTime', 'tx_hash', 'block_index', 'stamp'];",
                  "                if (!skipFields.includes(key) && !skipFields.some(f => newPath.includes(f))) {",
                  "                    differences.push({",
                  "                        type: 'changed',",
                  "                        path: newPath,",
                  "                        devValue: val1,",
                  "                        prodValue: val2",
                  "                    });",
                  "                }",
                  "            }",
                  "        }",
                  "    }",
                  "    ",
                  "    return differences;",
                  "}",
                  "",
                  "// Group results by endpoint",
                  "const grouped = {};",
                  "results.forEach(r => {",
                  "    if (!grouped[r.endpoint]) {",
                  "        grouped[r.endpoint] = {};",
                  "    }",
                  "    grouped[r.endpoint][r.environment] = r;",
                  "});",
                  "",
                  "console.log('\\n' + '='.repeat(80));",
                  "console.log('ðŸ” V2.3 REGRESSION TEST REPORT');",
                  "console.log('='.repeat(80));",
                  "console.log('Session ID:', pm.collectionVariables.get('test_session_id'));",
                  "console.log('Generated:', new Date().toISOString());",
                  "console.log('Total Requests:', results.length);",
                  "console.log('Dev Version: 2.3 | Prod Version: 2.2');",
                  "",
                  "let totalDifferences = 0;",
                  "let endpointsWithDifferences = 0;",
                  "let statusMismatches = 0;",
                  "let structureIssues = [];",
                  "",
                  "// Track v2.3 specific changes",
                  "const v23Fields = {",
                  "    marketData: 0,",
                  "    dispenserInfo: 0,",
                  "    cacheStatus: 0,",
                  "    holderCount: 0,",
                  "    uniqueHolderCount: 0,",
                  "    dataQualityScore: 0,",
                  "    stamp_base64_removed: 0,",
                  "    sale_data: 0,",
                  "    dayRange_param: 0,",
                  "    fullDetails_param: 0",
                  "};",
                  "",
                  "Object.keys(grouped).forEach(endpoint => {",
                  "    const dev = grouped[endpoint].development;",
                  "    const prod = grouped[endpoint].production;",
                  "    ",
                  "    if (dev && prod) {",
                  "        console.log(`\\n${endpoint}`);",
                  "        console.log('-'.repeat(60));",
                  "        ",
                  "        let endpointDiffs = 0;",
                  "        ",
                  "        // Compare status codes",
                  "        if (dev.status !== prod.status) {",
                  "            console.log(`   âŒ Status Code: Dev=${dev.status}, Prod=${prod.status}`);",
                  "            statusMismatches++;",
                  "            endpointDiffs++;",
                  "        } else {",
                  "            console.log(`   âœ… Status Code: ${dev.status}`);",
                  "        }",
                  "        ",
                  "        // Validate JSON structure and types",
                  "        const devStructureIssues = validateStructure(dev.body, 'Dev', endpoint);",
                  "        const prodStructureIssues = validateStructure(prod.body, 'Prod', endpoint);",
                  "        structureIssues.push(...devStructureIssues, ...prodStructureIssues);",
                  "        ",
                  "        if (devStructureIssues.length > 0 || prodStructureIssues.length > 0) {",
                  "            console.log(`   âš ï¸  Structure Issues Found:`);",
                  "            [...devStructureIssues, ...prodStructureIssues].forEach(issue => {",
                  "                console.log(`      - ${issue}`);",
                  "            });",
                  "            endpointDiffs += devStructureIssues.length + prodStructureIssues.length;",
                  "        }",
                  "        ",
                  "        // Deep compare response bodies",
                  "        const bodyDiffs = deepCompare(dev.body, prod.body);",
                  "        ",
                  "        if (bodyDiffs.length > 0) {",
                  "            endpointDiffs += bodyDiffs.length;",
                  "            console.log(`   âš ï¸  Response Differences Found (${bodyDiffs.length}):`);",
                  "            ",
                  "            // Group differences by type",
                  "            const added = bodyDiffs.filter(d => d.type === 'added');",
                  "            const removed = bodyDiffs.filter(d => d.type === 'removed');",
                  "            const changed = bodyDiffs.filter(d => d.type === 'changed');",
                  "            ",
                  "            if (added.length > 0) {",
                  "                console.log('      ðŸ“— Fields in DEV but not PROD (v2.3 additions):');",
                  "                added.forEach(d => {",
                  "                    console.log(`         - ${d.path}`);",
                  "                    // Track v2.3 specific fields",
                  "                    Object.keys(v23Fields).forEach(field => {",
                  "                        if (d.path.includes(field)) v23Fields[field]++;",
                  "                    });",
                  "                    // Track recent sales specific enhancements",
                  "                    if (endpoint.includes('/recentSales')) {",
                  "                        if (d.path.includes('sale_data')) v23Fields.sale_data++;",
                  "                        if (d.path.includes('dayRange')) v23Fields.dayRange_param++;",
                  "                        if (d.path.includes('fullDetails')) v23Fields.fullDetails_param++;",
                  "                    }",
                  "                });",
                  "            }",
                  "            ",
                  "            if (removed.length > 0) {",
                  "                console.log('      ðŸ“• Fields in PROD but not DEV (v2.3 removals):');",
                  "                removed.forEach(d => {",
                  "                    console.log(`         - ${d.path}`);",
                  "                    if (d.path.includes('stamp_base64')) v23Fields.stamp_base64_removed++;",
                  "                });",
                  "            }",
                  "            ",
                  "            if (changed.length > 0) {",
                  "                console.log('      ðŸ“™ Fields with different values:');",
                  "                changed.slice(0, 10).forEach(d => {",
                  "                    console.log(`         - ${d.path}`);",
                  "                    if (typeof d.devValue !== 'object' && typeof d.prodValue !== 'object') {",
                  "                        console.log(`           Dev: ${JSON.stringify(d.devValue)}`);",
                  "                        console.log(`           Prod: ${JSON.stringify(d.prodValue)}`);",
                  "                    }",
                  "                });",
                  "                if (changed.length > 10) {",
                  "                    console.log(`         ... and ${changed.length - 10} more differences`);",
                  "                }",
                  "            }",
                  "        }",
                  "        ",
                  "        if (endpointDiffs > 0) {",
                  "            endpointsWithDifferences++;",
                  "            totalDifferences += endpointDiffs;",
                  "        }",
                  "    }",
                  "});",
                  "",
                  "console.log('\\n' + '='.repeat(80));",
                  "console.log('ðŸ“Š SUMMARY');",
                  "console.log('='.repeat(80));",
                  "console.log('Endpoints Tested:', Object.keys(grouped).length);",
                  "console.log('Endpoints with Differences:', endpointsWithDifferences);",
                  "console.log('Status Code Mismatches:', statusMismatches);",
                  "console.log('Total Field Differences:', totalDifferences);",
                  "console.log('Structure/Type Issues:', structureIssues.length);",
                  "",
                  "if (structureIssues.length > 0) {",
                  "    console.log('\\\\nðŸ”§ STRUCTURE/TYPE ISSUES:');",
                  "    structureIssues.forEach(issue => console.log(`   - ${issue}`));",
                  "}",
                  "",
                  "// v2.3 specific changes summary",
                  "console.log('\\nðŸ“Œ V2.3 SPECIFIC CHANGES DETECTED:');",
                  "console.log(`   - marketData fields: ${v23Fields.marketData}`);",
                  "console.log(`   - dispenserInfo fields: ${v23Fields.dispenserInfo}`);",
                  "console.log(`   - cacheStatus fields: ${v23Fields.cacheStatus}`);",
                  "console.log(`   - holderCount fields: ${v23Fields.holderCount}`);",
                  "console.log(`   - uniqueHolderCount fields: ${v23Fields.uniqueHolderCount}`);",
                  "console.log(`   - dataQualityScore fields: ${v23Fields.dataQualityScore}`);",
                  "console.log(`   - stamp_base64 removed from lists: ${v23Fields.stamp_base64_removed}`);",
                  "console.log(`   - sale_data enhancements: ${v23Fields.sale_data}`);",
                  "console.log(`   - dayRange parameter support: ${v23Fields.dayRange_param}`);",
                  "console.log(`   - fullDetails parameter support: ${v23Fields.fullDetails_param}`);",
                  "",
                  "console.log('\\nðŸ“Œ Expected v2.3 Changes:');",
                  "console.log('   - marketData (new in v2.3) âœ“');",
                  "console.log('   - dispenserInfo (new in v2.3) âœ“');",
                  "console.log('   - cacheStatus (new in v2.3) âœ“');",
                  "console.log('   - holderCount/uniqueHolderCount (new in v2.3) âœ“');",
                  "console.log('   - dataQualityScore (new in v2.3) âœ“');",
                  "console.log('   - stamp_base64 excluded from lists in v2.3 âœ“');",
                  "console.log('   - Invalid tick validation (400 in dev, 200 in prod) âœ“');",
                  "console.log('   - Enhanced recent sales with sale_data (new in v2.3) âœ“');",
                  "console.log('   - Recent sales dayRange parameter (new in v2.3) âœ“');",
                  "console.log('   - Recent sales fullDetails parameter (new in v2.3) âœ“');",
                  "",
                  "// Performance regression analysis",
                  "console.log('\\nðŸ“Š PERFORMANCE REGRESSION ANALYSIS:');",
                  "const devBasicTime = pm.collectionVariables.get('dev_recent_sales_basic_time');",
                  "const prodBasicTime = pm.collectionVariables.get('prod_recent_sales_basic_time');",
                  "const devEnhancedTime = pm.collectionVariables.get('dev_recent_sales_enhanced_time');",
                  "const prodEnhancedTime = pm.collectionVariables.get('prod_recent_sales_enhanced_time');",
                  "",
                  "if (devBasicTime && prodBasicTime) {",
                  "    const basicTimeDiff = devBasicTime - prodBasicTime;",
                  "    const basicPercentDiff = ((basicTimeDiff / prodBasicTime) * 100).toFixed(1);",
                  "    console.log(`Recent Sales Basic: Dev=${devBasicTime}ms, Prod=${prodBasicTime}ms`);",
                  "    console.log(`  Performance Impact: ${basicTimeDiff > 0 ? '+' : ''}${basicTimeDiff}ms (${basicPercentDiff}%)`);",
                  "    ",
                  "    if (Math.abs(basicPercentDiff) > 50) {",
                  "        console.log('  âš ï¸  SIGNIFICANT PERFORMANCE REGRESSION DETECTED');",
                  "    } else if (Math.abs(basicPercentDiff) > 20) {",
                  "        console.log('  âš ï¸  Moderate performance change detected');",
                  "    } else {",
                  "        console.log('  âœ… Performance within acceptable range');",
                  "    }",
                  "}",
                  "",
                  "if (devEnhancedTime && prodEnhancedTime) {",
                  "    const enhancedTimeDiff = devEnhancedTime - prodEnhancedTime;",
                  "    const enhancedPercentDiff = ((enhancedTimeDiff / prodEnhancedTime) * 100).toFixed(1);",
                  "    console.log(`Recent Sales Enhanced: Dev=${devEnhancedTime}ms, Prod=${prodEnhancedTime}ms`);",
                  "    console.log(`  Performance Impact: ${enhancedTimeDiff > 0 ? '+' : ''}${enhancedTimeDiff}ms (${enhancedPercentDiff}%)`);",
                  "}",
                  "",
                  "if (devBasicTime && devEnhancedTime) {",
                  "    const enhancementOverhead = devEnhancedTime - devBasicTime;",
                  "    const overheadPercent = ((enhancementOverhead / devBasicTime) * 100).toFixed(1);",
                  "    console.log(`v2.3 Enhancement Overhead: ${enhancementOverhead}ms (${overheadPercent}%)`);",
                  "    ",
                  "    if (overheadPercent > 100) {",
                  "        console.log('  âš ï¸  HIGH OVERHEAD - Enhanced features significantly impact performance');",
                  "    } else if (overheadPercent > 50) {",
                  "        console.log('  âš ï¸  Moderate overhead from enhanced features');",
                  "    } else {",
                  "        console.log('  âœ… Enhanced features have minimal performance impact');",
                  "    }",
                  "}",
                  "",
                  "console.log('\\n' + '='.repeat(80));",
                  "",
                  "// Final assertions",
                  "pm.test(`Regression test completed: ${totalDifferences} differences found`, () => {",
                  "    pm.expect(totalDifferences).to.be.at.least(1); // Expect differences between v2.2 and v2.3",
                  "});",
                  "",
                  "pm.test('Performance regression check', () => {",
                  "    if (devBasicTime && prodBasicTime) {",
                  "        const performanceChange = Math.abs((devBasicTime - prodBasicTime) / prodBasicTime * 100);",
                  "        pm.expect(performanceChange).to.be.below(100, 'Performance regression > 100% detected');",
                  "    }",
                  "});",
                  "",
                  "pm.test('Recent sales endpoint backward compatibility', () => {",
                  "    // Ensure basic recent sales functionality works in both versions",
                  "    const recentSalesEndpoints = Object.keys(grouped).filter(ep => ep.includes('/recentSales'));",
                  "    recentSalesEndpoints.forEach(endpoint => {",
                  "        const dev = grouped[endpoint].development;",
                  "        const prod = grouped[endpoint].production;",
                  "        if (dev && prod) {",
                  "            // Both should return 200 for basic requests",
                  "            if (!endpoint.includes('dayRange') && !endpoint.includes('fullDetails')) {",
                  "                pm.expect(dev.status).to.equal(200, `Dev ${endpoint} should return 200`);",
                  "                pm.expect(prod.status).to.equal(200, `Prod ${endpoint} should return 200`);",
                  "            }",
                  "        }",
                  "    });",
                  "});"
                ]
              }
            }
          ]
        }
      ]
    }
  ]
}