{
  "info": {
    "name": "BTC Stamps Explorer API - Version Header Testing",
    "description": "Comprehensive X-API-Version header testing for v2.2 (no market data) and v2.3 (enhanced marketData structure) API compatibility",
    "version": "2.3.1",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "test_address",
      "value": "bc1qzxszplp8v7w0jc89dlrqyct9staqlhwxzy7lkq",
      "type": "string"
    },
    {
      "key": "test_src20_tick",
      "value": "STAMP",
      "type": "string"
    },
    {
      "key": "version_validation_results",
      "value": "[]",
      "type": "any"
    }
  ],
  "event": [
    {
      "listen": "prerequest",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Initialize version testing session",
          "if (!pm.collectionVariables.get('test_session_id')) {",
          "    pm.collectionVariables.set('test_session_id', Date.now().toString());",
          "    console.log('üîç Starting API Version Compatibility Testing');",
          "    console.log('  üìã Testing v2.2 (no market data) vs v2.3 (enhanced marketData structure)');",
          "    console.log('  üéØ Validating field transformations and schema compliance');",
          "}"
        ]
      }
    },
    {
      "listen": "test",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Store version test results for reporting",
          "const endpoint = pm.request.url.getPath();",
          "const version = pm.request.headers.get('X-API-Version') || 'default';",
          "const testResult = {",
          "    endpoint: endpoint,",
          "    version: version,",
          "    timestamp: new Date().toISOString(),",
          "    status: pm.response.code,",
          "    hasMarketData: false,",
          "    hasRootPriceFields: false",
          "};",
          "",
          "if (pm.response.to.have.status(200)) {",
          "    try {",
          "        const json = pm.response.json();",
          "        if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
          "            const firstItem = json.data[0];",
          "            testResult.hasMarketData = firstItem.hasOwnProperty('marketData');",
          "            testResult.hasRootPriceFields = firstItem.hasOwnProperty('floorPrice') || firstItem.hasOwnProperty('floorPriceUSD');",
          "        }",
          "    } catch (e) {",
          "        console.log('Error parsing response:', e);",
          "    }",
          "}",
          "",
          "// Store result for final reporting",
          "let results = pm.collectionVariables.get('version_validation_results') || '[]';",
          "try {",
          "    const resultArray = JSON.parse(results);",
          "    resultArray.push(testResult);",
          "    pm.collectionVariables.set('version_validation_results', JSON.stringify(resultArray));",
          "} catch (e) {",
          "    console.log('Error storing test result:', e);",
          "}"
        ]
      }
    }
  ],
  "item": [
    {
      "name": "üîÑ v2.2 API Tests - Legacy Format (No Market Data)",
      "item": [
        {
          "name": "Stamps List - v2.2 (No Market Data)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('‚úÖ v2.2 - Stamps endpoint responds successfully', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('‚ö° v2.2 - Response time acceptable', function () {",
                  "    pm.expect(pm.response.responseTime).to.be.below(5000);",
                  "});",
                  "",
                  "pm.test('üìã v2.2 - Response has valid JSON structure', function () {",
                  "    pm.response.to.have.jsonBody();",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('data');",
                  "    pm.expect(json.data).to.be.an('array');",
                  "});",
                  "",
                  "pm.test('üö´ v2.2 CRITICAL - No marketData field should exist', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        pm.expect(firstItem).to.not.have.property('marketData', 'v2.2 should never include marketData field');",
                  "    }",
                  "});",
                  "",
                  "pm.test('üö´ v2.2 CRITICAL - No root-level price fields should exist', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        pm.expect(firstItem).to.not.have.property('floorPrice', 'v2.2 should not have root floorPrice');",
                  "        pm.expect(firstItem).to.not.have.property('floorPriceUSD', 'v2.2 should not have root floorPriceUSD');",
                  "        pm.expect(firstItem).to.not.have.property('marketCapUSD', 'v2.2 should not have root marketCapUSD');",
                  "    }",
                  "});",
                  "",
                  "pm.test('‚úÖ v2.2 - Core stamp fields are present', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        pm.expect(firstItem).to.have.property('stamp');",
                  "        pm.expect(firstItem).to.have.property('cpid');",
                  "        pm.expect(firstItem).to.have.property('stamp_url');",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              },
              {
                "key": "X-API-Version",
                "value": "2.2",
                "description": "Request v2.2 format (no market data)"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v2/stamps?limit=5",
              "host": ["{{baseUrl}}"],
              "path": ["api", "v2", "stamps"],
              "query": [
                {
                  "key": "limit",
                  "value": "5"
                }
              ]
            }
          }
        },
        {
          "name": "SRC20 Balance List - v2.2 (No Market Data)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('‚úÖ v2.2 - SRC20 Balance endpoint responds', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('‚ö° v2.2 - Response time acceptable', function () {",
                  "    pm.expect(pm.response.responseTime).to.be.below(5000);",
                  "});",
                  "",
                  "pm.test('üìã v2.2 - Response has valid JSON structure', function () {",
                  "    pm.response.to.have.jsonBody();",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('data');",
                  "});",
                  "",
                  "pm.test('üö´ v2.2 CRITICAL - No marketData field should exist', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        pm.expect(firstItem).to.not.have.property('marketData', 'v2.2 should never include marketData field');",
                  "    }",
                  "});",
                  "",
                  "pm.test('üö´ v2.2 - Should not have v2.3 enhanced fields', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        pm.expect(firstItem).to.not.have.property('dispenserInfo');",
                  "        pm.expect(firstItem).to.not.have.property('cacheStatus');",
                  "        pm.expect(firstItem).to.not.have.property('dataQualityScore');",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              },
              {
                "key": "X-API-Version",
                "value": "2.2",
                "description": "Request v2.2 format (no market data)"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v2/src20/balance/{{test_address}}?limit=5",
              "host": ["{{baseUrl}}"],
              "path": ["api", "v2", "src20", "balance", "{{test_address}}"],
              "query": [
                {
                  "key": "limit",
                  "value": "5"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "üöÄ v2.3 API Tests - Enhanced Format (With MarketData)",
      "item": [
        {
          "name": "Stamps List - v2.3 (Enhanced MarketData)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('‚úÖ v2.3 - Stamps endpoint responds successfully', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('‚ö° v2.3 - Response time acceptable', function () {",
                  "    pm.expect(pm.response.responseTime).to.be.below(5000);",
                  "});",
                  "",
                  "pm.test('üìã v2.3 - Response has valid JSON structure', function () {",
                  "    pm.response.to.have.jsonBody();",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('data');",
                  "    pm.expect(json.data).to.be.an('array');",
                  "});",
                  "",
                  "pm.test('‚úÖ v2.3 CRITICAL - marketData field should exist', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        pm.expect(firstItem).to.have.property('marketData', 'v2.3 must include marketData field');",
                  "    }",
                  "});",
                  "",
                  "pm.test('üìä v2.3 - marketData structure validation', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        if (firstItem.marketData !== null && firstItem.marketData !== undefined) {",
                  "            pm.expect(firstItem.marketData).to.be.an('object');",
                  "            ",
                  "            // Core market data fields validation",
                  "            const marketData = firstItem.marketData;",
                  "            pm.expect(marketData).to.have.property('floorPriceBTC');",
                  "            pm.expect(marketData).to.have.property('volume24hBTC');",
                  "            pm.expect(marketData).to.have.property('holderCount');",
                  "            pm.expect(marketData).to.have.property('dataQualityScore');",
                  "            pm.expect(marketData).to.have.property('priceSource');",
                  "            ",
                  "            // Validate data types",
                  "            if (marketData.floorPriceBTC !== null) {",
                  "                pm.expect(marketData.floorPriceBTC).to.be.a('number');",
                  "            }",
                  "            if (marketData.holderCount !== null) {",
                  "                pm.expect(marketData.holderCount).to.be.a('number');",
                  "            }",
                  "        }",
                  "    }",
                  "});",
                  "",
                  "pm.test('üö´ v2.3 CRITICAL - No root-level price fields should exist', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        pm.expect(firstItem).to.not.have.property('floorPrice', 'v2.3 should not have root floorPrice - moved to marketData.floorPriceBTC');",
                  "        pm.expect(firstItem).to.not.have.property('floorPriceUSD', 'v2.3 should not have root floorPriceUSD - moved to marketData.floorPriceUSD');",
                  "        pm.expect(firstItem).to.not.have.property('marketCapUSD', 'v2.3 should not have root marketCapUSD - calculated from marketData');",
                  "    }",
                  "});",
                  "",
                  "pm.test('‚úÖ v2.3 - Enhanced fields are present', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        pm.expect(firstItem).to.have.property('dispenserInfo');",
                  "        pm.expect(firstItem).to.have.property('cacheStatus');",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              },
              {
                "key": "X-API-Version",
                "value": "2.3",
                "description": "Request v2.3 format (enhanced market data)"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v2/stamps?limit=5",
              "host": ["{{baseUrl}}"],
              "path": ["api", "v2", "stamps"],
              "query": [
                {
                  "key": "limit",
                  "value": "5"
                }
              ]
            }
          }
        },
        {
          "name": "SRC20 Balance List - v2.3 (Enhanced MarketData)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('‚úÖ v2.3 - SRC20 Balance endpoint responds', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('‚ö° v2.3 - Response time acceptable', function () {",
                  "    pm.expect(pm.response.responseTime).to.be.below(5000);",
                  "});",
                  "",
                  "pm.test('üìã v2.3 - Response has valid JSON structure', function () {",
                  "    pm.response.to.have.jsonBody();",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('data');",
                  "});",
                  "",
                  "pm.test('‚úÖ v2.3 CRITICAL - marketData field should exist', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        pm.expect(firstItem).to.have.property('marketData', 'v2.3 must include marketData field');",
                  "    }",
                  "});",
                  "",
                  "pm.test('üìä v2.3 - SRC20 marketData structure validation', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        if (firstItem.marketData !== null && firstItem.marketData !== undefined) {",
                  "            pm.expect(firstItem.marketData).to.be.an('object');",
                  "            ",
                  "            // SRC20-specific market data fields",
                  "            const marketData = firstItem.marketData;",
                  "            pm.expect(marketData).to.have.property('floorPriceBTC');",
                  "            pm.expect(marketData).to.have.property('volume24hBTC');",
                  "            pm.expect(marketData).to.have.property('totalVolumeBTC');",
                  "            pm.expect(marketData).to.have.property('holderCount');",
                  "            pm.expect(marketData).to.have.property('uniqueHolderCount');",
                  "            pm.expect(marketData).to.have.property('lastUpdated');",
                  "            ",
                  "            // Validate timestamps are properly formatted",
                  "            if (marketData.lastUpdated !== null) {",
                  "                pm.expect(marketData.lastUpdated).to.match(/\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}/);",
                  "            }",
                  "        }",
                  "    }",
                  "});",
                  "",
                  "pm.test('üö´ v2.3 CRITICAL - Should NOT have root-level market fields', function () {",
                  "    const json = pm.response.json();",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        pm.expect(firstItem).to.not.have.property('floorPrice', 'v2.3 moved floorPrice to marketData.floorPriceBTC');",
                  "        pm.expect(firstItem).to.not.have.property('floorPriceUSD', 'v2.3 moved floorPriceUSD to marketData.floorPriceUSD');",
                  "        pm.expect(firstItem).to.not.have.property('marketCapUSD', 'v2.3 removed root marketCapUSD field');",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              },
              {
                "key": "X-API-Version",
                "value": "2.3",
                "description": "Request v2.3 format (enhanced market data)"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v2/src20/balance/{{test_address}}?limit=5",
              "host": ["{{baseUrl}}"],
              "path": ["api", "v2", "src20", "balance", "{{test_address}}"],
              "query": [
                {
                  "key": "limit",
                  "value": "5"
                }
              ]
            }
          }
        },
        {
          "name": "Collections List - v2.3 (Enhanced MarketData)",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "pm.test('‚úÖ v2.3 - Collections endpoint responds successfully', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('‚ö° v2.3 - Response time acceptable', function () {",
                  "    pm.expect(pm.response.responseTime).to.be.below(5000);",
                  "});",
                  "",
                  "pm.test('üìã v2.3 - Collections response structure validation', function () {",
                  "    const json = pm.response.json();",
                  "    pm.expect(json).to.have.property('data');",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstCollection = json.data[0];",
                  "        pm.expect(firstCollection).to.have.property('collection_name');",
                  "        pm.expect(firstCollection).to.have.property('stamp_count');",
                  "        pm.expect(firstCollection).to.have.property('total_editions');",
                  "        ",
                  "        // Collections may have marketData if available",
                  "        if (firstCollection.marketData) {",
                  "            pm.expect(firstCollection.marketData).to.be.an('object');",
                  "            pm.expect(firstCollection.marketData).to.have.property('minFloorPriceBTC');",
                  "            pm.expect(firstCollection.marketData).to.have.property('totalUniqueHolders');",
                  "        }",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              },
              {
                "key": "X-API-Version",
                "value": "2.3",
                "description": "Request v2.3 format (enhanced market data)"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v2/collections?limit=5",
              "host": ["{{baseUrl}}"],
              "path": ["api", "v2", "collections"],
              "query": [
                {
                  "key": "limit",
                  "value": "5"
                }
              ]
            }
          }
        }
      ]
    },
    {
      "name": "üîç Cross-Version Comparison Tests",
      "item": [
        {
          "name": "Compare Same Endpoint Across Versions",
          "event": [
            {
              "listen": "test",
              "script": {
                "type": "text/javascript",
                "exec": [
                  "// This test validates the same endpoint returns consistent core data across versions",
                  "pm.test('üîÑ Cross-version consistency check', function () {",
                  "    pm.response.to.have.status(200);",
                  "    const json = pm.response.json();",
                  "    ",
                  "    // Store response for comparison in collection variable",
                  "    const version = pm.request.headers.get('X-API-Version') || 'default';",
                  "    const storageKey = `comparison_${version}_response`;",
                  "    pm.collectionVariables.set(storageKey, JSON.stringify(json));",
                  "    ",
                  "    console.log(`üìã Stored ${version} response for cross-version comparison`);",
                  "});",
                  "",
                  "pm.test('üìä Schema validation summary', function () {",
                  "    const json = pm.response.json();",
                  "    const version = pm.request.headers.get('X-API-Version') || 'default';",
                  "    ",
                  "    if (json.data && Array.isArray(json.data) && json.data.length > 0) {",
                  "        const firstItem = json.data[0];",
                  "        const hasMarketData = firstItem.hasOwnProperty('marketData');",
                  "        const hasRootPriceFields = firstItem.hasOwnProperty('floorPrice');",
                  "        ",
                  "        console.log(`üìã Version ${version} Schema Summary:`);",
                  "        console.log(`   marketData field: ${hasMarketData}`);",
                  "        console.log(`   Root price fields: ${hasRootPriceFields}`);",
                  "        console.log(`   Enhanced fields: ${firstItem.hasOwnProperty('dispenserInfo')}`);",
                  "        ",
                  "        if (version === '2.2') {",
                  "            pm.expect(hasMarketData).to.be.false;",
                  "            pm.expect(hasRootPriceFields).to.be.false;",
                  "        } else if (version === '2.3') {",
                  "            pm.expect(hasMarketData).to.be.true;",
                  "            pm.expect(hasRootPriceFields).to.be.false;",
                  "        }",
                  "    }",
                  "});"
                ]
              }
            }
          ],
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Accept",
                "value": "application/json"
              },
              {
                "key": "X-API-Version",
                "value": "{{api_version_for_comparison}}",
                "description": "Dynamic version for comparison testing"
              }
            ],
            "url": {
              "raw": "{{baseUrl}}/api/v2/stamps?limit=3",
              "host": ["{{baseUrl}}"],
              "path": ["api", "v2", "stamps"],
              "query": [
                {
                  "key": "limit",
                  "value": "3"
                }
              ]
            }
          }
        }
      ]
    }
  ],
  "event": [
    {
      "listen": "postman",
      "script": {
        "type": "text/javascript",
        "exec": [
          "// Final test results summary",
          "console.log('üéØ API Version Compatibility Testing Complete');",
          "console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');",
          "",
          "try {",
          "    const results = pm.collectionVariables.get('version_validation_results');",
          "    if (results) {",
          "        const testResults = JSON.parse(results);",
          "        const v22Tests = testResults.filter(r => r.version === '2.2');",
          "        const v23Tests = testResults.filter(r => r.version === '2.3');",
          "        ",
          "        console.log(`üìä Test Summary:`);",
          "        console.log(`   v2.2 Tests: ${v22Tests.length}`);",
          "        console.log(`   v2.3 Tests: ${v23Tests.length}`);",
          "        console.log(`   Total Endpoints Tested: ${testResults.length}`);",
          "        ",
          "        const v22WithMarketData = v22Tests.filter(r => r.hasMarketData).length;",
          "        const v23WithMarketData = v23Tests.filter(r => r.hasMarketData).length;",
          "        ",
          "        console.log(`üîç Schema Compliance:`);",
          "        console.log(`   v2.2 with marketData: ${v22WithMarketData} (should be 0)`);",
          "        console.log(`   v2.3 with marketData: ${v23WithMarketData} (should be ${v23Tests.length})`);",
          "        ",
          "        if (v22WithMarketData > 0) {",
          "            console.log('‚ö†Ô∏è  WARNING: v2.2 endpoints returning marketData field!');",
          "        }",
          "        if (v23WithMarketData < v23Tests.length) {",
          "            console.log('‚ö†Ô∏è  WARNING: Some v2.3 endpoints missing marketData field!');",
          "        }",
          "        if (v22WithMarketData === 0 && v23WithMarketData === v23Tests.length) {",
          "            console.log('‚úÖ All version-specific schema validations passed!');",
          "        }",
          "    }",
          "} catch (e) {",
          "    console.log('Error generating summary:', e);",
          "}",
          "",
          "console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');",
          "console.log('üöÄ Ready for production deployment!');"
        ]
      }
    }
  ]
}
