import { assertEquals, assertExists } from "@std/assert";
import { describe, it, beforeEach, afterEach } from "@std/testing/bdd";
import { render, fireEvent, waitFor, cleanup } from "@testing-library/preact";
import { signal } from "@preact/signals";
import {
  MaraModeIndicator,
  MaraModeIndicatorCompact,
  MaraModeBadge,
} from "$/components/indicators/MaraModeIndicator.tsx";
import { AccessibilityUtils } from "$utils/ui/accessibility/accessibilityUtils.ts";
import { stub, returnsNext } from "@std/testing/mock";
import { setupDOM, teardownDOM } from "@tests/unit/utils/testHelpers.ts";

describe("MaraModeIndicator", () => {
  let prefersReducedMotionStub: any;

  beforeEach(() => {
    // Setup DOM environment
    setupDOM();
    
    // Mock AccessibilityUtils
    prefersReducedMotionStub = stub(
      AccessibilityUtils,
      "prefersReducedMotion",
      returnsNext([false])
    );
  });

  afterEach(() => {
    cleanup();
    prefersReducedMotionStub.restore();
    teardownDOM();
  });

  describe("Main Component", () => {
    it("should render with required props", () => {
      const { getByRole } = render(
        <MaraModeIndicator outputValue={330} />
      );

      const button = getByRole("button");
      assertExists(button);
      assertEquals(button.getAttribute("aria-expanded"), "false");
    });

    it("should display output value", () => {
      const { getByText } = render(
        <MaraModeIndicator outputValue={330} />
      );

      assertExists(getByText("330 sat outputs"));
    });

    it("should display fee rate when provided", () => {
      const { getByText } = render(
        <MaraModeIndicator outputValue={330} feeRate={6} />
      );

      assertExists(getByText("6 sat/vB min"));
    });

    it("should not display fee rate when null", () => {
      const { queryByText } = render(
        <MaraModeIndicator outputValue={330} feeRate={null} />
      );

      assertEquals(queryByText(/sat\/vB min/), null);
    });

    it("should apply custom className", () => {
      const { container } = render(
        <MaraModeIndicator outputValue={330} class="custom-class" />
      );

      const element = container.querySelector(".custom-class");
      assertExists(element);
    });

    describe("Accessibility", () => {
      it("should have proper ARIA attributes", () => {
        const { getByRole } = render(
          <MaraModeIndicator outputValue={330} feeRate={6} />
        );

        const button = getByRole("button");
        assertEquals(button.getAttribute("tabIndex"), "0");
        assertExists(button.getAttribute("aria-label"));
        assertEquals(button.getAttribute("aria-expanded"), "false");
      });

      it("should generate descriptive aria-label", () => {
        const { getByRole } = render(
          <MaraModeIndicator outputValue={330} feeRate={6} />
        );

        const button = getByRole("button");
        const label = button.getAttribute("aria-label");
        assertExists(label);
        assertEquals(label?.includes("MARA Pool optimized mode active"), true);
        assertEquals(label?.includes("Output value: 330 sats"), true);
        assertEquals(label?.includes("minimum fee rate: 6 sat/vB"), true);
      });

      it("should respect reduced motion preference", () => {
        prefersReducedMotionStub = stub(
          AccessibilityUtils,
          "prefersReducedMotion",
          returnsNext([true])
        );

        const { container } = render(
          <MaraModeIndicator outputValue={330} />
        );

        // Should not have animation classes
        const animatedElements = container.querySelectorAll(".animate-pulse, .animate-ping");
        assertEquals(animatedElements.length, 0);
      });
    });

    describe("Tooltip Interaction", () => {
      it("should show tooltip on mouse hover after delay", async () => {
        const { getByRole, queryByRole } = render(
          <MaraModeIndicator outputValue={330} feeRate={6} />
        );

        const button = getByRole("button");
        
        // Initially no tooltip
        assertEquals(queryByRole("tooltip"), null);

        // Hover
        fireEvent.mouseEnter(button);

        // Wait for tooltip delay
        await waitFor(() => {
          const tooltip = queryByRole("tooltip");
          assertExists(tooltip);
        }, { timeout: 1000 });
      });

      it("should hide tooltip on mouse leave", async () => {
        const { getByRole, queryByRole } = render(
          <MaraModeIndicator outputValue={330} />
        );

        const button = getByRole("button");
        
        // Show tooltip
        fireEvent.mouseEnter(button);
        await waitFor(() => assertExists(queryByRole("tooltip")));

        // Hide tooltip
        fireEvent.mouseLeave(button);
        assertEquals(queryByRole("tooltip"), null);
      });

      it("should toggle tooltip on click", () => {
        const { getByRole, queryByRole } = render(
          <MaraModeIndicator outputValue={330} />
        );

        const button = getByRole("button");
        
        // Click to show
        fireEvent.click(button);
        assertExists(queryByRole("tooltip"));

        // Click to hide
        fireEvent.click(button);
        assertEquals(queryByRole("tooltip"), null);
      });

      it("should toggle tooltip on Enter key", () => {
        const { getByRole, queryByRole } = render(
          <MaraModeIndicator outputValue={330} />
        );

        const button = getByRole("button");
        
        // Press Enter to show
        fireEvent.keyDown(button, { key: "Enter" });
        assertExists(queryByRole("tooltip"));

        // Press Enter to hide
        fireEvent.keyDown(button, { key: "Enter" });
        assertEquals(queryByRole("tooltip"), null);
      });

      it("should hide tooltip on Escape key", () => {
        const { getByRole, queryByRole } = render(
          <MaraModeIndicator outputValue={330} />
        );

        const button = getByRole("button");
        
        // Show tooltip
        fireEvent.click(button);
        assertExists(queryByRole("tooltip"));

        // Press Escape to hide
        fireEvent.keyDown(button, { key: "Escape" });
        assertEquals(queryByRole("tooltip"), null);
      });

      it("should update aria-expanded when tooltip is shown", () => {
        const { getByRole } = render(
          <MaraModeIndicator outputValue={330} />
        );

        const button = getByRole("button");
        
        // Initially collapsed
        assertEquals(button.getAttribute("aria-expanded"), "false");

        // Show tooltip
        fireEvent.click(button);
        assertEquals(button.getAttribute("aria-expanded"), "true");
      });
    });

    describe("Tooltip Content", () => {
      it("should display all MARA benefits", () => {
        const { getByRole, getByText } = render(
          <MaraModeIndicator outputValue={330} feeRate={6} />
        );

        fireEvent.click(getByRole("button"));

        assertExists(getByText("MARA Pool Benefits"));
        assertExists(getByText(/Non-standard transactions with 330 sat outputs/));
        assertExists(getByText("Direct submission to MARA mining pool"));
        assertExists(getByText("Bypasses standard mempool restrictions"));
        assertExists(getByText("Service fee: 42,000 sats per transaction"));
        assertExists(getByText("Minimum fee rate: 6 sat/vB"));
      });

      it("should show warning about standard wallets", () => {
        const { getByRole, getByText } = render(
          <MaraModeIndicator outputValue={330} />
        );

        fireEvent.click(getByRole("button"));

        assertExists(getByText(/Standard wallets cannot broadcast these transactions/));
      });
    });
  });

  describe("MaraModeIndicatorCompact", () => {
    it("should render compact version", () => {
      const { getByRole, getByText } = render(
        <MaraModeIndicatorCompact outputValue={330} />
      );

      const status = getByRole("status");
      assertExists(status);
      assertExists(getByText("MARA â€¢ 330 sat"));
    });

    it("should have proper aria-label", () => {
      const { getByRole } = render(
        <MaraModeIndicatorCompact outputValue={330} />
      );

      const status = getByRole("status");
      assertEquals(
        status.getAttribute("aria-label"),
        "MARA Pool optimized mode: 330 sat outputs"
      );
    });

    it("should apply custom className", () => {
      const { container } = render(
        <MaraModeIndicatorCompact outputValue={330} class="custom-compact" />
      );

      const element = container.querySelector(".custom-compact");
      assertExists(element);
    });

    it("should respect reduced motion", () => {
      prefersReducedMotionStub = stub(
        AccessibilityUtils,
        "prefersReducedMotion",
        returnsNext([true])
      );

      const { container } = render(
        <MaraModeIndicatorCompact outputValue={330} />
      );

      const animatedElements = container.querySelectorAll(".animate-pulse");
      assertEquals(animatedElements.length, 0);
    });
  });

  describe("MaraModeBadge", () => {
    it("should render badge", () => {
      const { getByText } = render(<MaraModeBadge />);

      assertExists(getByText("MARA"));
    });

    it("should apply custom className", () => {
      const { container } = render(
        <MaraModeBadge class="custom-badge" />
      );

      const element = container.querySelector(".custom-badge");
      assertExists(element);
    });

    it("should have indicator dot", () => {
      const { container } = render(<MaraModeBadge />);

      const dot = container.querySelector(".bg-purple-400.rounded-full");
      assertExists(dot);
    });
  });
});