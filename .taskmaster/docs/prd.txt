# Fix bitcoinjs-lib v7.0.0-rc.0 PSBT Data Type Compatibility Issue

## Problem Statement

The BTCStampsExplorer application is experiencing critical runtime errors when creating SRC-20 transactions due to data type incompatibility with bitcoinjs-lib v7.0.0-rc.0. The error occurs in the PSBT (Partially Signed Bitcoin Transaction) creation process where the `witnessUtxo.value` field is expected to be a `bigint` but is being passed as a `number`.

### Error Details
```
Data for input key witnessUtxo is incorrect: Expected { script: Uint8Array; value: bigint; } 
and got {"script":{"0":0,"1":20,...},"value":280891}
```

This error occurs in:
- `SRC20PSBTService.preparePSBT()` at line 116
- `SRC20MultisigPSBTService.preparePSBT()` 
- Other PSBT-related services

## Root Cause Analysis

1. **bitcoinjs-lib v7.0.0-rc.0 Breaking Changes**: The library now requires `witnessUtxo.value` to be `bigint` instead of `number`
2. **Type Inconsistency**: The codebase was updated to fix TypeScript errors but the runtime data types weren't properly converted
3. **Middleware Impact**: Recent type fixes may have affected how data flows through the API middleware

## Requirements

### Functional Requirements
1. **Fix Data Type Conversion**: Ensure all `witnessUtxo.value` fields are converted to `bigint`
2. **Maintain Backward Compatibility**: Ensure existing functionality continues to work
3. **Comprehensive Testing**: Validate with real Bitcoin UTXO data
4. **Error Handling**: Proper error handling for type conversion failures

### Technical Requirements
1. **Scope**: Fix all PSBT services that create `witnessUtxo` objects
2. **Type Safety**: Ensure TypeScript types match runtime expectations
3. **Performance**: Minimize performance impact of type conversions
4. **Testing**: Mock real Bitcoin addresses with fixtures for comprehensive testing

### Quality Requirements
1. **Reliability**: 100% success rate for valid PSBT creation
2. **Maintainability**: Clear documentation of type conversion patterns
3. **Testability**: Comprehensive test coverage with realistic scenarios

## Implementation Strategy

### Phase 1: Analysis & Planning
- Identify all locations where `witnessUtxo` objects are created
- Analyze current type definitions and their alignment with bitcoinjs-lib v7.0.0-rc.0
- Create comprehensive test fixtures with real Bitcoin UTXO data

### Phase 2: Core Fixes
- Update `SRC20PSBTService.preparePSBT()` method
- Update `SRC20MultisigPSBTService.preparePSBT()` method
- Update other PSBT-related services (stampMintService, psbtService, etc.)
- Ensure consistent `BigInt()` conversion for all value fields

### Phase 3: Testing & Validation
- Create mock Bitcoin addresses with realistic UTXO data
- Test all transaction types (mint, deploy, transfer)
- Validate with different script types (P2WPKH, P2WSH, P2SH, etc.)
- Performance testing to ensure no degradation

### Phase 4: Documentation & Cleanup
- Update type definitions to reflect bigint requirements
- Document the conversion patterns for future development
- Clean up any related type casting issues

## Success Criteria

1. **Zero Runtime Errors**: No more "Data for input key witnessUtxo is incorrect" errors
2. **Full Functionality**: All SRC-20 operations (mint, deploy, transfer) work correctly
3. **Type Safety**: TypeScript compilation with no type errors related to PSBT data
4. **Test Coverage**: Comprehensive test suite covering all PSBT creation scenarios
5. **Performance**: No significant performance degradation (< 5% impact)

## Technical Constraints

1. **Library Version**: Must work with bitcoinjs-lib@7.0.0-rc.0 (no downgrade)
2. **Existing API**: Maintain existing API contracts and response formats
3. **Database**: No database schema changes required
4. **Deployment**: Changes should be backward compatible

## Risks & Mitigation

### High Risk
- **Data Corruption**: Incorrect type conversion could corrupt transaction data
  - *Mitigation*: Comprehensive testing with real UTXO data
- **Performance Impact**: BigInt operations may be slower than number operations
  - *Mitigation*: Performance benchmarking and optimization

### Medium Risk
- **Type System Inconsistency**: Mixing number and bigint types could cause confusion
  - *Mitigation*: Clear documentation and consistent patterns
- **Testing Complexity**: Mocking real Bitcoin data is complex
  - *Mitigation*: Use actual testnet/mainnet UTXO data for fixtures

## Deliverables

1. **Fixed PSBT Services**: All PSBT creation services working with bitcoinjs-lib v7.0.0-rc.0
2. **Comprehensive Tests**: Test suite with realistic Bitcoin UTXO fixtures
3. **Updated Type Definitions**: TypeScript types aligned with runtime expectations
4. **Documentation**: Implementation guide for future PSBT-related development
5. **Performance Report**: Benchmarking results showing no significant degradation

## Timeline

- **Phase 1**: Analysis & Planning (1 day)
- **Phase 2**: Core Fixes (2 days) 
- **Phase 3**: Testing & Validation (2 days)
- **Phase 4**: Documentation & Cleanup (1 day)

**Total Estimated Time**: 6 days

## Definition of Done

- [ ] All PSBT creation methods work without runtime errors
- [ ] Comprehensive test suite passes with realistic UTXO data
- [ ] TypeScript compilation successful with no type errors
- [ ] Performance benchmarks show acceptable impact
- [ ] Documentation updated with new patterns
- [ ] Code review completed and approved
- [ ] Deployed to staging environment and tested 